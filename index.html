<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>王家睿的留言板与简介</title> <!-- 修改标题 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // 添加全局播放控制变量
    window.hasAutoPlayedOnce = false;
    window.isUserPaused = false;
    window.oncePlayOnBodyHandler = null;
    window.spectrumAnimationId = null;
    window.audioContext = null;
    window.analyser = null;
    window.dataArray = null;

    const firebaseConfig = {
      apiKey: "AIzaSyAYftoevTnczZimCLzzJujqFqBXcReMvt8",
      authDomain: "metalphon-7ed49.firebaseapp.com",
      projectId: "metalphon-7ed49",
      storageBucket: "metalphon-7ed49.appspot.com",
      messagingSenderId: "965453822169",
      appId: "1:965453822169:web:8ea6ec693243af8892e6c8",
      measurementId: "G-Y6LN2HHHH7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let loadingAnimationElement = null;

    function showLoading() {
      if (loadingAnimationElement) loadingAnimationElement.style.display = "flex";
    }

    function hideLoading() {
      if (loadingAnimationElement) loadingAnimationElement.style.display = "none";
    }

    function showLogin() {
      document.getElementById("welcome-section").style.display = "block";
      document.getElementById("profile-section").style.display = "none";
      document.getElementById("leave-section").style.display = "none";
      document.getElementById("matrix-bg").style.display = "block";
      document.querySelector('.menu').style.display = 'none';
    }

    function initializeTreeIfNeeded() {
      // 可选：如果iframe懒加载，可在此处动态加载
    }

    window.startChat = () => {
      // 1. 自动播放音乐
      const audio = document.getElementById('navbar-audio');
      const musicToggle = document.getElementById('music-toggle');
      const navbarSpectrum = document.getElementById('navbar-spectrum');
      
      if (audio && !window.hasAutoPlayedOnce && !window.isUserPaused) {
        audio.play().then(() => {
          if (musicToggle) musicToggle.checked = true;
          if (navbarSpectrum) navbarSpectrum.style.display = 'block';
          window.hasAutoPlayedOnce = true;
          if (typeof window.initAudioAnalyserGlobal === 'function') {
            window.initAudioAnalyserGlobal(audio);
            window.drawSpectrumGlobal(navbarSpectrum);
          }
        }).catch(() => {
          // 自动播放被阻止时，添加一次性点击事件
          if (!window.isUserPaused && !window.oncePlayOnBodyHandler) {
            window.oncePlayOnBodyHandler = () => {
              audio.play().then(() => {
                if (musicToggle) musicToggle.checked = true;
                if (navbarSpectrum) navbarSpectrum.style.display = 'block';
                window.hasAutoPlayedOnce = true;
                if (typeof window.initAudioAnalyserGlobal === 'function') {
                  window.initAudioAnalyserGlobal(audio);
                  window.drawSpectrumGlobal(navbarSpectrum);
                }
              }).catch(() => {});
              document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
              window.oncePlayOnBodyHandler = null;
            };
            document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
          }
        });
      }
      // --- END ---
      const nameInput = document.getElementById("nickname").value.trim();
      if (nameInput) {
        document.getElementById("personal-info-wrapper").style.display = "none";
        document.getElementById("tree-of-life-embed").style.display = "block";
        initializeTreeIfNeeded();
        currentUser = nameInput;
        document.getElementById("welcome-section").style.display = "none";
        document.getElementById("profile-section").style.display = "block";
        document.querySelectorAll('.page-section').forEach(sec => {
          if (sec.id !== 'profile-section') {
            sec.style.display = 'none';
          }
        });
        const leaveSectionDiv = document.getElementById("leave-section");
        if (leaveSectionDiv) {
          leaveSectionDiv.style.display = "none";
        }
        const mainChatWelcomeName = document.querySelector('#chat-section.page-section #welcome-name');
        if(mainChatWelcomeName) mainChatWelcomeName.textContent = currentUser;
        if (!loadingAnimationElement) {
            loadingAnimationElement = document.getElementById("loading-animation");
        }
        loadMessages();
        document.getElementById("bottom-menu").style.display = "flex";
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        const navHome = document.getElementById('nav-home');
        if (navHome) navHome.classList.add('active');
        if (window.showMusicPlayer) {
            window.showMusicPlayer();
        }
      } else {
        alert("请输入你的昵称！");
      }
    };

    window.submitMessage = async () => {
      const input = document.getElementById("message-input");
      const message = input.value.trim();

      if (!currentUser) {
        alert("请先进入留言板（设置昵称）。");
        return;
      }
      if (!message) {
        alert("留言内容不能为空！");
        return;
      }

      showLoading(); 
      const messagesContainer = document.getElementById("messages");
      messagesContainer.innerHTML = ''; 

      try {
        await addDoc(collection(db, "messages"), {
          user: currentUser,
          content: message,
          timestamp: serverTimestamp() 
        });
        input.value = "";
      } catch (error) {
        console.error("Error adding document: ", error);
        alert("发送留言失败，请查看控制台获取更多信息。");
        hideLoading(); 
      } finally {
        loadMessages(); 
      }
    };

    window.loadMessages = async () => {
      const container = document.getElementById("messages");
      showLoading(); 

      try {
        const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        let html = "";
        if (querySnapshot.empty) {
          html = "<p>还没有留言，快来抢沙发吧！</p>";
        } else {
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const date = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString('zh-CN') : '发送中...'; // 使用中文区域设置
            html += `
              <div class="message-item">
                <strong class="message-user">${data.user || "匿名"}</strong>
                <span class="message-timestamp">(${date})</span>：
                <span class="message-content">${data.content}</span>
              </div>
            `;
          });
        }
        container.innerHTML = html;
      } catch (error) {
        console.error("Error loading messages: ", error);
        container.innerHTML = "<p style='color:red;'>加载留言失败，请检查网络或稍后再试。</p>";
      } finally {
        hideLoading(); 
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadingAnimationElement = document.getElementById("loading-animation");
        // 登录页时隐藏底部菜单
        document.getElementById("bottom-menu").style.display = "none";
        // 切换内容区时显示底部菜单
        const links = document.querySelectorAll('.menu .link');
        links.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            // 切换高亮
            links.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            // 切换内容区
            const target = this.getAttribute('data-target');
            document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
            if(target === 'chat-section') {
              document.getElementById('chat-section').style.display = 'block';
            } else {
              document.getElementById(target).style.display = 'block';
            }
            // 显示底部菜单
            document.getElementById("bottom-menu").style.display = "flex";
          });
        });
    });

  </script>

  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }
    .center-bg {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .form, .card {
      width: 100vw !important;
      max-width: 100vw !important;
      min-height: 100vh !important;
      margin: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      background: transparent !important;
      padding: 40px 0 !important;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .form > p {
      color: var(--font-color);
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form > p > span {
      color: var(--font-color-sub);
      font-weight: 600;
      font-size: 17px;
    }
    .separator {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .separator > div {
      width: 100px;
      height: 3px;
      border-radius: 5px;
      background-color: var(--font-color-sub);
    }
    .separator > span {
      color: var(--font-color);
      font-weight: 600;
    }
    .oauthButton {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      width: 250px;
      height: 40px;
      border-radius: 5px;
      border: 2px solid var(--main-color);
      background-color: var(--bg-color);
      box-shadow: 4px 4px var(--main-color);
      font-size: 16px;
      font-weight: 600;
      color: var(--font-color);
      cursor: pointer;
      transition: all 250ms;
      position: relative;
      overflow: hidden;
      z-index: 1;
      padding: 0 15px;
    }
    .oauthButton::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: #212121;
      z-index: -1;
      box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
      transition: all 250ms;
    }
    .oauthButton:hover {
      color: #e8e8e8;
    }
    .oauthButton:hover::before {
      width: 100%;
    }
    .form > input {
      width: 250px;
      height: 40px;
      border-radius: 5px;
      border: 2px solid var(--main-color);
      background-color: var(--bg-color);
      box-shadow: 4px 4px var(--main-color);
      font-size: 15px;
      font-weight: 600;
      color: var(--font-color);
      padding: 5px 10px;
      outline: none;
    }
    .icon {
      width: 1.5rem;
      height: 1.5rem;
    }
    .hero-bg {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0; left: 0;
      z-index: 0;
    }
    .hero-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.18);
      padding: 3rem 2.5rem 2.5rem 2.5rem;
      text-align: center;
      max-width: 420px;
      width: 100%;
      animation: fadeInUp 1s;
      z-index: 1;
    }
    .avatar {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px rgba(99,102,241,0.18);
      border: 4px solid #a5b4fc;
      object-fit: cover;
    }
    h1 {
      font-size: 2.2rem;
      color: #4f46e5;
      margin-bottom: 0.5rem;
      font-weight: 800;
      letter-spacing: 1px;
    }
    .subtitle {
      font-size: 1.1rem;
      color: #6366f1;
        margin-bottom: 0.8rem;
    }
    .intro {
        color: #374151;
      margin-bottom: 1.5rem;
      font-size: 1rem;
    }
    .input-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: bold;
        text-align: left;
    }
    .input, #messages {
      width: 90vw !important;
      max-width: 900px;
    }
    .input:focus {
        border-color: #4f46e5;
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }
    .btn {
      background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      padding: 10px 20px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(99,102,241,0.12);
    }
    .btn:hover {
      background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
      transform: translateY(-2px) scale(1.04);
    }
    .btn:active {
        background: #3730a3;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    /* 让后续内容不受全屏背景影响 */
    #profile-section, #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 2;
      padding: 40px 0;
      box-sizing: border-box;
    }
    #chat-section {
      background: rgba(255,255,255,0.98);
    }
    #profile-section > *, #chat-section > * {
      width: 90vw;
      max-width: 900px;
    }
    .card {
      width: 100%;
      max-width: 600px; 
      margin: 1rem auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* 简介部分的特定样式 */
    #profile-section h2 {
        color: #4f46e5; /* 与按钮颜色呼应 */
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }
    #profile-section p {
        margin-bottom: 0.8rem;
        line-height: 1.6;
        color: #374151;
    }
    #profile-section strong {
        color: #1f2937;
    }

    #messages {
        margin-top: 1.5rem;
        max-height: 300px; /* 调整高度为简介腾出空间 */
        overflow-y: auto; 
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        background-color: #f9fafb;
        min-height: 50px; 
    }

    .message-item {
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background-color: #ffffff; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #4f46e5; 
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    .message-user {
        font-weight: bold;
        color: #374151;
    }
    .message-timestamp {
        font-size: 0.8rem;
        color: #6b7280;
        margin-left: 0.5rem;
    }
    .message-content {
        display: block; 
        margin-top: 0.25rem;
        color: #1f2937;
        word-wrap: break-word; 
    }

    /* Loading Animation Styles */
    .loader {
      --ANIMATION-DELAY-MULTIPLIER: 70ms;
      padding: 0;
      margin: 20px auto; 
      display: none; 
      flex-direction: row;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      height: 50px; 
    }
    .loader span {
      padding: 0;
      margin: 0 2px; /* 增加字母间距 */
      letter-spacing: 0; /* 修改为0，不再挤在一起 */
      animation-delay: 0s;
      transform: translateY(4rem);
      animation: hideAndSeek 1s alternate infinite cubic-bezier(0.86, 0, 0.07, 1);
    }
    .loader .l { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 0); }
    .loader .o { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 1); }
    .loader .a { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 2); }
    .loader .d { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 3); }
    .loader .ispan { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 4); }
    .loader .n { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 5); }
    .loader .g { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 6); }
    .letter { width: fit-content; height: 3rem; }
    .ispan .letter { margin-inline: 5px; }
    @keyframes hideAndSeek {
      0% { transform: translateY(4rem); }
      100% { transform: translateY(0rem); }
    }

    #particles-js {
      position: absolute;
      width: 100vw;
      height: 100vh;
      top: 0; left: 0;
      z-index: 0;
    }
    .hero-card {
      position: relative;
      z-index: 2;
    }
    .hero-bg {
      position: relative;
      z-index: 1;
    }
    .pixel-bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      left: 0; top: 0;
      pointer-events: none;
      z-index: 0;
    }
    .pixel-board {
      position: absolute;
      opacity: 0.7;
    }
    .pixel-board-tl { left: 2vw; top: 2vh; transform: rotate(-10deg);}
    .pixel-board-br { right: 2vw; bottom: 2vh; transform: rotate(12deg);}
    .pixel-board-tr { right: 8vw; top: 8vh; transform: rotate(6deg);}
    .pixel-board-bl { left: 8vw; bottom: 8vh; transform: rotate(-7deg);}
    .chip-wall-bg, .chip-wall-grid, .chip-svg { display: none !important; }
    #matrix-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: #000;
      opacity: 1;
    }
    .center-bg, .form, #welcome-section, #profile-section, #chat-section {
      position: relative;
      z-index: 1;
    }
    /* 弹窗样式（全屏覆盖） */
    #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.98);
      border-radius: 0;
      box-shadow: none;
      z-index: 1000;
      display: none;
      overflow: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #profile-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff !important;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .menu {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      padding: 0.5rem 1.5rem;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      border-radius: 15px;
      box-shadow: 0 10px 25px 0 rgba(0,0,0,0.075);
      z-index: 2000;
    }
    .link {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 70px;
      height: 50px;
      border-radius: 8px;
      position: relative;
      z-index: 1;
      overflow: hidden;
      transform-origin: center left;
      transition: width 0.2s ease-in;
      text-decoration: none;
      color: inherit;
      background: transparent;
    }
    .link:before {
      position: absolute;
      z-index: -1;
      content: "";
      display: block;
      border-radius: 8px;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      transform: translateX(100%);
      transition: transform 0.2s ease-in;
      transform-origin: center right;
      background-color: #eee;
    }
    .link:hover,
    .link:focus {
      outline: 0;
      width: 130px;
    }
    .link:hover:before,
    .link:focus:before,
    .link:hover .link-title,
    .link:focus .link-title {
      transform: translateX(0);
      opacity: 1;
    }
    .link-icon {
      width: 28px;
      height: 28px;
      display: block;
      flex-shrink: 0;
      left: 18px;
      position: absolute;
    }
    .link-icon svg {
      width: 28px;
      height: 28px;
    }
    .link-title {
      transform: translateX(100%);
      transition: transform 0.2s ease-in;
      transform-origin: center right;
      display: block;
      text-align: center;
      text-indent: 28px;
      width: 100%;
    }
    /* 恢复登录界面.form卡片样式 */
    .form {
      padding: 24px 18px;
      background: #ede9fe !important;
      border-radius: 22px;
      border: 1.5px solid #e0e7ef;
      box-shadow: 0 6px 32px 0 rgba(99,102,241,0.06), 0 1.5px 0 #e0e7ef inset;
      max-width: 320px;
      width: 100%;
      margin: 60px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .form:focus-within, .form:hover {
      box-shadow: 0 8px 40px 0 rgba(99,102,241,0.10), 0 2px 0 #b3bcf5 inset;
      border-color: #b3bcf5;
    }
    #profile-section, #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 2;
      padding: 40px 0;
      box-sizing: border-box;
    }
    #profile-section {
      background: #fff !important;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.08);
    }
    #chat-section {
      background: rgba(255,255,255,0.98);
    }
    #profile-section > *, #chat-section > * {
      width: 90vw;
      max-width: 900px;
    }
    /* From Uiverse.io by Praashoo7 */
    .input {
      border: none;
      outline: none;
      border-radius: 15px;
      padding: 1em;
      background-color: #ccc;
      box-shadow: inset 2px 5px 10px rgba(0,0,0,0.3);
      transition: 300ms ease-in-out;
    }
    .input:focus {
      background-color: white;
      transform: scale(1.05);
      box-shadow: 13px 13px 100px #969696,
                 -13px -13px 100px #ffffff;
    }
    .chat-flex {
      display: flex;
      width: 90vw;
      max-width: 1100px;
      height: 70vh;
      min-height: 400px;
      margin: 0 auto;
      background: transparent;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .chat-input-area, .chat-messages-area {
      flex: 1 1 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: #f8fafc;
      padding: 2.5rem 2rem;
      box-sizing: border-box;
    }
    .chat-input-area {
      border-right: 1.5px solid #e5e7eb;
      align-items: center;
    }
    .chat-input-area h2,
    .chat-input-area label,
    .chat-input-area input,
    .chat-input-area button,
    .chat-input-area .loader {
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .chat-messages-area {
      flex: 1 1 0;
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: #fff;
      overflow-y: auto;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 0 0.5rem 0 0.5rem;
    }
    #messages {
      width: 100%;
      max-width: 100%;
      height: 100%;
      min-height: 100%;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin: 0;
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
    }
    /* 美化滚动条 */
    .chat-messages-area::-webkit-scrollbar, #messages::-webkit-scrollbar {
      width: 8px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .chat-messages-area::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb {
      background: #b3bcf5;
      border-radius: 8px;
    }
    /* 让message-item宽度自适应 */
    .message-item {
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    /* 修改留言界面为全屏页面风格，区域更大，内容居中，宽度放宽 */
    #chat-section.page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    #chat-section.page-section > .chat-flex {
      max-width: 1400px;
      width: 96vw;
      height: 80vh;
      min-height: 500px;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.10);
      background: rgba(255,255,255,0.98);
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: center;
      padding: 0;
    }
    /* 不应用.page-section > div的通用内容区样式到.chat-flex */
    #chat-section.page-section > div:not(.chat-flex) {
      background: none;
      box-shadow: none;
      padding: 0;
      min-height: 0;
    }
    .container-card-charts {
      position: relative;
      width: 300px;
      height: 300px;
      background: linear-gradient(
        to top,
        rgba(255, 255, 255),
        rgba(255, 255, 255, 0.1)
      );
      border-radius: 32px;
      padding: 1.6px;
      box-shadow: 0 0px 80px -10px rgba(255, 255, 255, 0.15);
    }
    .container-card-charts::before {
      position: absolute;
      content: "";
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      background-color: #777777;
      z-index: -10;
      filter: blur(70px);
    }
    .card-charts {
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #1b1b1b, #000000);
      border-radius: 32px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .charts-lines {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .charts-lines i {
      position: absolute;
      inset: 0;
      display: flex;
      width: 100%;
      height: 100%;
    }
    .lines {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: space-between;
    }
    .lines span {
      width: 1.5px;
      height: 100%;
      margin: 0 18px;
      background: linear-gradient(
        to top,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.025) 50%,
        rgba(255, 255, 255, 0) 100%
      );
    }
    .tags-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
    }
    .tags-card .radio {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      border-radius: 12px;
      color: #a7a7a7;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .tags-card .radio:hover {
      color: #ffffff;
    }
    .tags-card .radio input {
      display: none;
    }
    .tags-card .radio .name {
      width: 100%;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      z-index: 1;
    }
    .tags-card .radio input:checked + .name {
      color: #ffffff;
      background: linear-gradient(15deg, #898989, #181818, #000000);
      transform: scale(1.1);
    }
    .tags-card .radio input:checked + .name::before {
      position: absolute;
      background-color: #212121;
      content: "";
      inset: 1px;
      z-index: -1;
      border-radius: 12px;
    }
    .main-texts {
      display: flex;
      flex-direction: column;
      padding: 0 20px;
      font-weight: 500;
    }
    .main-texts .title {
      background-image: linear-gradient(to top left, #92400e, #f9d86d, #a6a6a6);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
    .main-texts .change {
      background-image: linear-gradient(to right, #8e1414, #ffffff, #ffffff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
    .charts-lines path {
      opacity: 0;
    }
    .card-charts svg {
      transition: transform 0.5s ease;
    }
    .card-charts:hover svg {
      transform: scale(1.5);
    }
    .icon-week path {
      animation: draw 8s ease infinite;
    }
    .icon-month path {
      animation: draw 8s 3s ease infinite;
    }
    @keyframes draw {
      0% {
        stroke-dashoffset: 1500;
        opacity: 0.8;
      }
      50% {
        stroke-dashoffset: 0;
      }
      100% {
        stroke-dashoffset: -1500;
        opacity: 0.8;
      }
    }
    /* 让所有 .page-section 区块全屏独立，内容居中，宽度自适应 */
    .page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    /* 让内容区块宽度适中且居中美观 */
    .page-section > div {
      max-width: 1200px;
      width: 90vw;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.10);
      padding: 40px 32px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
    }
    /* 针对 repo-section 内部卡片容器特殊处理，避免重复包裹 */
    #repo-section > div {
      background: none;
      box-shadow: none;
      padding: 0;
      min-height: 0;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 56px;
      height: 56px;
      position: fixed;
      left: unset;
      right: 20px;
      bottom: 30px;
      border-radius: 12px; /* 方形圆角 */
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2100;
    }
    .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: conic-gradient(#ff6347, #ff6347);
      cursor: pointer;
      outline: none;
    }
   
    .play-btn:checked {
      animation: borderAnimate 700ms ease-in-out 1;
      animation-fill-mode: forwards;
    }
    @keyframes borderAnimate {
      0% {
        transform: rotate(0);
        background: conic-gradient(#ff6347, transparent 20%);
      }
      80% {
        background: conic-gradient(#ff6347, transparent 90%);
      }
      100% {
        transform: rotate(360deg);
        background: conic-gradient(#ff6347, #ff6347);
      }
    }
    .play-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 60%;
      top: 50%;
      background-color: #ff6347;
      transform: translate(-60%, -50%) rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      cursor: pointer;
    }
    .play-btn:checked + .play-icon {
      clip-path: polygon(0 100%, 0% 100%, 100% 100%);
    }
    .pause-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .pause-icon::before {
      content: "";
      position: absolute;
      width: 0%;
      height: 100%;
      background-color: #ff6347;
      left: 0;
    }
    .pause-icon::after {
      content: "";
      position: absolute;
      width: 0;
      height: 100%;
      background-color: #ff6347;
      right: 0;
    }
    .play-btn:checked ~ .pause-icon::before {
      animation: reveal 300ms ease-in-out 350ms 1;
      animation-fill-mode: forwards;
    }
    .play-btn:checked ~ .pause-icon::after {
      animation: reveal 300ms ease-in-out 600ms 1;
      animation-fill-mode: forwards;
    }
    @keyframes reveal {
      0% {
        width: 0;
      }
      100% {
        width: 35%;
      }
    }
    #music-visualizer-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      pointer-events: none;
      z-index: 1;
    }
    .music-btn-core {
      width: 60px;
      height: 60px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: #000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border: 2px solid #ff6347;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      cursor: pointer;
      outline: none;
      z-index: 3;
      opacity: 0;
    }
    .play-icon {
      width: 20px;
      height: 20px;
      background-color: #ff6347;
      transform: rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      z-index: 1;
    }
    .pause-icon {
      width: 18px;
      height: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
      opacity: 0;
      pointer-events: none;
    }
    .pause-icon::before,
    .pause-icon::after {
      content: "";
      display: block;
      width: 6px;
      height: 100%;
      background-color: #ff6347;
      border-radius: 1px;
    }
    .play-btn:checked + .play-icon {
      opacity: 0;
      pointer-events: none;
    }
    .play-btn:checked ~ .pause-icon {
      opacity: 1;
      pointer-events: auto;
    }

    /* 方形播放按钮样式，适配导航栏 */
    .navbar-play-btn {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      margin-left: 12px;
      position: relative;
    }
    .navbar-play-btn .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: conic-gradient(#ff6347, #ff6347);
      cursor: pointer;
      outline: none;
    }
    .navbar-play-btn .play-btn::before {
      content: "";
      position: absolute;
      width: 93%;
      height: 93%;
      background-color: #000;
      border-radius: 8px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .navbar-play-btn .play-btn:checked {
      animation: borderAnimate 700ms ease-in-out 1;
      animation-fill-mode: forwards;
    }
    @keyframes borderAnimate {
      0% {
        transform: rotate(0);
        background: conic-gradient(#ff6347, transparent 20%);
      }
      80% {
        background: conic-gradient(#ff6347, transparent 90%);
      }
      100% {
        transform: rotate(360deg);
        background: conic-gradient(#ff6347, #ff6347);
      }
    }
    .navbar-play-btn .play-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 60%;
      top: 50%;
      background-color: #ff6347;
      transform: translate(-60%, -50%) rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      cursor: pointer;
    }
    .navbar-play-btn .play-btn:checked + .play-icon {
      clip-path: polygon(0 100%, 0% 100%, 100% 100%);
    }
    .navbar-play-btn .pause-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .navbar-play-btn .pause-icon::before {
      content: "";
      position: absolute;
      width: 0%;
      height: 100%;
      background-color: #ff6347;
      left: 0;
    }
    .navbar-play-btn .pause-icon::after {
      content: "";
      position: absolute;
      width: 0;
      height: 100%;
      background-color: #ff6347;
      right: 0;
    }
    .navbar-play-btn .play-btn:checked ~ .pause-icon::before {
      animation: reveal 300ms ease-in-out 350ms 1;
      animation-fill-mode: forwards;
    }
    .navbar-play-btn .play-btn:checked ~ .pause-icon::after {
      animation: reveal 300ms ease-in-out 600ms 1;
      animation-fill-mode: forwards;
    }
    @keyframes reveal {
      0% {
        width: 0;
      }
      100% {
        width: 35%;
      }
    }
    /* 导航栏上方频谱条样式（修正版） */
    #navbar-spectrum {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100px;
      z-index: 1999;
      width: 380px;
      max-width: 85vw;
      height: 50px;
      pointer-events: none;
      display: none;
      background: transparent;
      opacity: 0.8;
    }
    /* 放大登录界面整体、输入框、按钮和文字 */
    #welcome-section.form {
      max-width: 480px !important;
      width: 100% !important;
      padding: 48px 0 !important;
    }
    #welcome-section .avatar {
      width: 120px;
      height: 120px;
      margin-bottom: 2rem !important;
    }
    #welcome-section p {
      font-size: 2.2rem !important;
      margin-bottom: 1.2rem !important;
    }
    #welcome-section p > span {
      font-size: 1.3rem !important;
    }
    #welcome-section .intro {
      font-size: 1.25rem !important;
      margin-bottom: 1.5rem !important;
    }
    #welcome-section input[type="text"] {
      width: 340px !important;
      height: 54px !important;
      font-size: 1.2rem !important;
      padding: 10px 18px !important;
      border-radius: 12px !important;
    }
    #welcome-section .oauthButton {
      width: 340px !important;
      height: 54px !important;
      font-size: 1.25rem !important;
      border-radius: 12px !important;
      margin-top: 1.2rem !important;
    }
    #archive-section.page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    #archive-section .center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    #archive-section .center-content > div {
      max-width: 1000px !important;
      width: 100vw !important;
      min-height: 500px !important;
    }
    #archive-section.page-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 60px;
      padding-bottom: 60px;
    }
    #archive-section .center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 90vw;
      max-width: 1400px;
    }
    #archive-section .charts-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      box-sizing: border-box;
    }
    #archive-section .charts-container > div {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
    }
    #archive-section .charts-container > div > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
    }
    #archive-section .charts-container svg {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }
    /* GitHub按钮样式 */
    .btn-github {
      text-decoration: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border: none;
      transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
      border-radius: 100px;
      font-weight: 800;
      padding: 0.75rem 1rem;
      font-size: 0.825rem;
      line-height: 1rem;
      background-color: rgba(0, 0, 0, 0.4);
      box-shadow:
        inset 0 1px 0 0 rgba(255, 255, 255, 0.04),
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      color: #fff !important;
    }
    .btn-github:hover {
      box-shadow:
        inset 0 1px 0 0 rgba(255, 255, 255, 0.08),
        inset 0 0 0 1px rgba(252, 232, 3, 0.08);
      color: #fce803 !important;
      transform: translate(0, -0.25rem);
      background-color: rgba(0, 0, 0, 0.5);
    }
    .btn-github svg {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="center-bg">
    <form action="javascript:void(0);" class="form" id="welcome-section">
      <img src="https://api.dicebear.com/7.x/miniavs/svg?seed=王家睿" class="avatar" alt="头像" style="margin-bottom: 1rem;" />
      <p style="margin-bottom:0;">
        王家睿的个人简历
        <span>欢迎来到我的专属空间</span>
      </p>
      <div class="intro" style="text-align:center; color:#374151; font-size:15px; margin-bottom:0;">
        重庆理工大学 · 电子信息工程 · 热爱编程与创新
      </div>
      <input type="text" placeholder="请输入你的昵称" id="nickname" name="nickname">
      <button class="oauthButton" type="button" onclick="startChat()">
        进入留言与查看简历
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 17 5-5-5-5"></path><path d="m13 17 5-5-5-5"></path></svg>
      </button>
    </form>
    <div id="leave-section" style="display:none;"></div>
    </div>
  
    <!-- 个人简介 -->
  <div id="profile-section" style="display:none;">
    <div id="personal-info-wrapper">
      <h2>关于我 - 王家睿</h2>
      <p><strong>学校：</strong> 重庆理工大学</p>
      <p><strong>学院：</strong> 电气与电子工程学院</p>
      <p><strong>专业：</strong> 电子信息工程</p>
      <p><strong>绩点：</strong> 3.2 / 5.0</p>
      <hr>
    </div>
    <div id="tree-of-life-embed" style="display:none; margin-top:0;">
      <iframe src="final.htm" style="width:100vw;height:100vh;border:none;display:block;background:#fff;" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
  <div id="chat-section" class="page-section" style="display:none;">
    <div class="chat-flex">
      <div class="chat-input-area">
      <h2>💬 欢迎 <span id="welcome-name"></span>！请留言：</h2>
      <label class="input-label" for="message-input">你的留言：</label>
      <input class="input" placeholder="写点什么..." type="text" id="message-input" />
      <button class="btn" onclick="submitMessage()">提交留言</button>
      <div id="loading-animation" class="loader">
          <span class="l">L</span><span class="o">O</span><span class="a">A</span><span class="d">D</span><span class="ispan">I</span><span class="n">N</span><span class="g">G</span>
      </div>
      </div>
      <div class="chat-messages-area">
        <div class="mt-6" id="messages"></div>
      </div>
    </div>
  </div>
  <!-- 导航条放在body最外层 -->
  <div class="menu" id="bottom-menu" style="display:none;">
    <a href="#" class="link active" id="nav-home" data-target="profile-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256">
          <rect width="256" height="256" fill="none"></rect>
          <path d="M213.3815,109.61945,133.376,36.88436a8,8,0,0,0-10.76339.00036l-79.9945,72.73477A8,8,0,0,0,40,115.53855V208a8,8,0,0,0,8,8H208a8,8,0,0,0,8-8V115.53887A8,8,0,0,0,213.3815,109.61945Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
        </svg>
      </span>
      <span class="link-title">首页</span>
    </a>
    <a href="#" class="link" id="nav-repo" data-target="repo-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.39C18.93 3.53 18.48 3.5 18.07 3.5H5.93c-.41 0-.86.03-1.08.34l-1.39 1.39C3.21 5.42 3 5.7 3 6v2c0 .55.45 1 1 1h1v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V9h1c.55 0 1-.45 1-1V6c0-.3-.21-.58-.46-.77zM19 8H5V6.12l.93-.92h12.14l.93.92V8zm-2 10H7V9h10v9z"/></svg>
      </span>
      <span class="link-title">仓库</span>
    </a>
    <a href="#" class="link" id="nav-archive" data-target="archive-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
      </span>
      <span class="link-title">成就</span>
    </a>
    <a href="#" class="link" id="nav-chat" data-target="chat-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6h-2v9H5V6H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 14H3v-2h18v2zm0-4H3v-2h18v2zm0-4H3v-2h18v2z"/></svg>
      </span>
      <span class="link-title">留言</span>
    </a>
    <div class="navbar-play-btn" id="navbar-play-btn">
      <input type="checkbox" class="play-btn" id="music-toggle">
      <span class="play-icon"></span>
      <span class="pause-icon"></span>
      <audio id="navbar-audio" src="mytreasure纯音乐.mp4" preload="auto"></audio>
      </div>
    </div>
  
  <!-- 在导航条旁边插入按钮 -->


  <!-- 在导航栏.menu上方插入频谱canvas -->
  <canvas id="navbar-spectrum"></canvas>
  </body>
  </html>

<script>
  // 全局音频变量
  window.hasAutoPlayedOnce = window.hasAutoPlayedOnce || false;
  window.isUserPaused = window.isUserPaused || false;
  window.oncePlayOnBodyHandler = window.oncePlayOnBodyHandler || null;
  window.spectrumAnimationId = window.spectrumAnimationId || null;
  window.audioContext = window.audioContext || null;
  window.analyser = window.analyser || null;
  window.dataArray = window.dataArray || null;

  // 全局音频分析器初始化函数
  window.initAudioAnalyserGlobal = function(audioPlayer) {
    if (!window.audioContext || window.audioContext.state === 'closed') {
      console.log("创建新的AudioContext");
      window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = window.audioContext.createMediaElementSource(audioPlayer);
      window.analyser = window.audioContext.createAnalyser();
      window.analyser.fftSize = 256;
      source.connect(window.analyser);
      window.analyser.connect(window.audioContext.destination);
      window.dataArray = new Uint8Array(window.analyser.frequencyBinCount);
      console.log("全局AudioContext和Analyser已初始化/重新初始化");
    } else if (window.audioContext.state === 'suspended') {
      window.audioContext.resume().then(() => {
        console.log("AudioContext在initAudioAnalyserGlobal中已恢复");
      }).catch(e => console.error("AudioContext恢复失败:", e));
    }
  };

  // 全局频谱绘制函数
  window.drawSpectrumGlobal = function(navbarSpectrum) {
    if (!window.analyser || !window.audioContext) {
      console.warn("drawSpectrumGlobal: Analyser或AudioContext未就绪");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      if(navbarSpectrum) navbarSpectrum.style.display = 'none';
      return;
    }

    const audioPlayerElement = document.getElementById('navbar-audio');

    if (window.audioContext.state === 'suspended') {
      window.audioContext.resume().then(() => {
        console.log("AudioContext在drawSpectrumGlobal中已恢复。请求动画帧");
        if (audioPlayerElement && !audioPlayerElement.paused && !window.isUserPaused) {
          navbarSpectrum.style.display = 'block';
        } else {
          navbarSpectrum.style.display = 'none';
        }
        if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
        window.spectrumAnimationId = requestAnimationFrame(() => window.drawSpectrumGlobal(navbarSpectrum));
      }).catch(e => {
        console.error("AudioContext在drawSpectrumGlobal中恢复失败:", e);
        if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
        window.spectrumAnimationId = null;
        navbarSpectrum.style.display = 'none';
      });
      return;
    }

    if (window.audioContext.state === 'closed') {
      console.warn("AudioContext已关闭。无法绘制频谱");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      navbarSpectrum.style.display = 'none';
      return;
    }

    if (audioPlayerElement && (audioPlayerElement.paused || window.isUserPaused)) {
      console.log("音频已暂停或用户暂停，停止频谱");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      navbarSpectrum.style.display = 'none';
      const ctx = navbarSpectrum.getContext('2d');
      if (ctx) ctx.clearRect(0, 0, navbarSpectrum.width, navbarSpectrum.height);
      return;
    }

    if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
    window.spectrumAnimationId = requestAnimationFrame(() => window.drawSpectrumGlobal(navbarSpectrum));

    window.analyser.getByteFrequencyData(window.dataArray);

    const canvas = navbarSpectrum;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    const barWidth = (width / window.dataArray.length) * 2.5;
    let x = 0;

    for (let i = 0; i < window.dataArray.length; i++) {
      const barHeight = (window.dataArray[i] / 255) * height;
      const gradient = ctx.createLinearGradient(0, height, 0, 0);
      gradient.addColorStop(0, '#4f46e5');
      gradient.addColorStop(0.5, '#6366f1');
      gradient.addColorStop(1, '#a5b4fc');
      ctx.fillStyle = gradient;
      ctx.fillRect(x, height - barHeight, barWidth, barHeight);
      x += barWidth + 1;
    }
  };

  document.addEventListener('DOMContentLoaded', function() {
    const musicToggleElement = document.getElementById('music-toggle');
    const audioPlayerElement = document.getElementById('navbar-audio');
    const navbarSpectrumElement = document.getElementById('navbar-spectrum');

    if (musicToggleElement && audioPlayerElement && navbarSpectrumElement) {
      navbarSpectrumElement.width = 380;
      navbarSpectrumElement.height = 50;

      musicToggleElement.checked = !audioPlayerElement.paused && window.hasAutoPlayedOnce && !window.isUserPaused;
      navbarSpectrumElement.style.display = musicToggleElement.checked ? 'block' : 'none';

      musicToggleElement.addEventListener('change', function() {
        if (this.checked) {
          window.isUserPaused = false;
          const playLogic = () => {
            audioPlayerElement.play().then(() => {
              console.log("通过开关启动播放");
              if (window.oncePlayOnBodyHandler) {
                document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
                window.oncePlayOnBodyHandler = null;
              }
            }).catch(error => {
              console.error("开关播放失败:", error);
              this.checked = false;
              window.isUserPaused = true;
              navbarSpectrumElement.style.display = 'none';
            });
          };

          if (window.audioContext && window.audioContext.state === 'suspended') {
            window.audioContext.resume().then(playLogic).catch(e => {
              console.error("播放前恢复上下文失败:", e);
              this.checked = false;
              window.isUserPaused = true;
              navbarSpectrumElement.style.display = 'none';
            });
          } else {
            playLogic();
          }
        } else {
          window.isUserPaused = true;
          audioPlayerElement.pause();
        }
      });

      audioPlayerElement.addEventListener('play', function() {
        console.log("'play'事件。isUserPaused:", window.isUserPaused);
        if (!window.isUserPaused) {
          musicToggleElement.checked = true;
          navbarSpectrumElement.style.display = 'block';
          window.initAudioAnalyserGlobal(audioPlayerElement);
          window.drawSpectrumGlobal(navbarSpectrumElement);
        } else {
          audioPlayerElement.pause();
          musicToggleElement.checked = false;
          navbarSpectrumElement.style.display = 'none';
        }
        if (window.oncePlayOnBodyHandler) {
          document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
          window.oncePlayOnBodyHandler = null;
        }
      });

      audioPlayerElement.addEventListener('pause', function() {
        console.log("'pause'事件。isUserPaused:", window.isUserPaused);
        if (window.isUserPaused || audioPlayerElement.paused) {
          musicToggleElement.checked = false;
        }
        navbarSpectrumElement.style.display = 'none';
        if (window.spectrumAnimationId) {
          cancelAnimationFrame(window.spectrumAnimationId);
          window.spectrumAnimationId = null;
        }
        const spectrumCtx = navbarSpectrumElement.getContext('2d');
        if (spectrumCtx) spectrumCtx.clearRect(0, 0, navbarSpectrumElement.width, navbarSpectrumElement.height);

        if (window.audioContext && window.audioContext.state === 'running' && window.isUserPaused) {
          window.audioContext.suspend().catch(e => console.error("暂停时挂起失败", e));
        }
      });

      audioPlayerElement.addEventListener('ended', function() {
        console.log("'ended'事件。isUserPaused:", window.isUserPaused);
        audioPlayerElement.currentTime = 0;
        if (!window.isUserPaused) {
          const playPromise = audioPlayerElement.play();
          if (playPromise !== undefined) {
            playPromise.catch(e => {
              console.log("结束后循环播放尝试失败:", e);
              if (!window.isUserPaused && !window.oncePlayOnBodyHandler) {
                window.oncePlayOnBodyHandler = () => {
                  window.isUserPaused = false;
                  audioPlayerElement.play().catch(() => {});
                  document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
                  window.oncePlayOnBodyHandler = null;
                };
                document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
              }
            });
          }
        } else {
          musicToggleElement.checked = false;
          navbarSpectrumElement.style.display = 'none';
        }
      });
    }

    setTimeout(() => {
      if (audioPlayerElement && !window.hasAutoPlayedOnce && audioPlayerElement.paused && !window.isUserPaused) {
        console.log("初始自动播放回退：添加body点击监听器");
        if (!window.oncePlayOnBodyHandler) {
          window.oncePlayOnBodyHandler = () => {
            console.log("初始播放的body点击处理程序触发");
            window.isUserPaused = false;
            audioPlayerElement.play().then(() => {
              window.hasAutoPlayedOnce = true;
            }).catch((err) => {
              console.error("body点击初始播放失败:", err);
            });
            document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
            window.oncePlayOnBodyHandler = null;
          };
          document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
        }
      }
    }, 500);

    // 其他DOMContentLoaded逻辑
    var showBtn = document.getElementById('show-leave-btn');
    var leaveSection = document.getElementById('leave-section');
    if(showBtn && leaveSection) {
      showBtn.addEventListener('click', function() {
        showBtn.style.display = 'none';
        leaveSection.style.display = 'block';
      });
    }

    // 导航相关函数
    const navChatButton = document.getElementById('nav-chat');
    if (navChatButton) {
      navChatButton.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        document.getElementById('chat-section').style.display = 'block';
        const leaveSectionDiv = document.getElementById('leave-section');
        if (leaveSectionDiv) {
          leaveSectionDiv.style.display = 'none';
        }
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    }

    const navRepoButton = document.getElementById('nav-repo');
    if (navRepoButton) {
      navRepoButton.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        const repoSection = document.getElementById('repo-section');
        if (repoSection) repoSection.style.display = 'block';
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    }

    // 主导航逻辑
    document.querySelectorAll('.menu .link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        const targetId = this.getAttribute('data-target');
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.style.display = 'block';
          if (targetId === 'archive-section') {
            setTimeout(() => {
              if (typeof initGradesChart === 'function') initGradesChart();
              if (typeof initCoursesChart === 'function') initCoursesChart();
            }, 100);
          }
        } else {
          console.warn("未找到目标部分:", targetId);
        }
        
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');

        if (targetId === 'profile-section') {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
          if (treeEmbed) treeEmbed.style.display = 'block';
        } else if (targetId === 'chat-section') {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
          if (treeEmbed) treeEmbed.style.display = 'none';
        } else {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
          if (treeEmbed) treeEmbed.style.display = 'none';
        }
        
        document.getElementById("bottom-menu").style.display = "flex";
      });
    });

    // 矩阵雨和地图卡片逻辑
    const matrixRainCard = document.getElementById('matrix-rain-card');
    const chongqingMapCard = document.getElementById('chongqing-map-card');
    const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
    const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
    const closeMatrixRain = document.getElementById('close-matrix-rain');
    const closeChongqingMap = document.getElementById('close-chongqing-map');

    let matrixRainCanvas, matrixRainCtx, matrixRainInterval;
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
    const drops = [];

    function initMatrixRain() {
      matrixRainCanvas = document.getElementById('matrix-rain-canvas');
      if (!matrixRainCanvas) return;
      
      matrixRainCtx = matrixRainCanvas.getContext('2d');
      matrixRainCanvas.width = window.innerWidth;
      matrixRainCanvas.height = window.innerHeight;
      
      const columns = Math.floor(matrixRainCanvas.width / 20);
      drops.length = 0;
      for (let i = 0; i < columns; i++) {
        drops[i] = 1 + Math.random() * matrixRainCanvas.height / 20;
      }
      
      if (matrixRainInterval) clearInterval(matrixRainInterval);
      matrixRainInterval = setInterval(drawMatrixRain, 33);
    }

    function drawMatrixRain() {
      if (!matrixRainCtx || !matrixRainCanvas) return;
      matrixRainCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      matrixRainCtx.fillRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
      
      matrixRainCtx.fillStyle = '#0F0';
      matrixRainCtx.font = '15px monospace';
      
      for (let i = 0; i < drops.length; i++) {
        const text = chars[Math.floor(Math.random() * chars.length)];
        matrixRainCtx.fillText(text, i * 20, drops[i] * 20);
        
        if (drops[i] * 20 > matrixRainCanvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
    }

    function stopMatrixRain() {
      if (matrixRainInterval) {
        clearInterval(matrixRainInterval);
        matrixRainInterval = null;
      }
      if (matrixRainCtx && matrixRainCanvas) {
        matrixRainCtx.clearRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
      }
    }
    
    if (matrixRainCard && matrixRainFullscreen) {
      matrixRainCard.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'flex';
        initMatrixRain();
      });
    }

    if (closeMatrixRain) {
      closeMatrixRain.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'none';
        stopMatrixRain();
      });
    }

    if (chongqingMapCard && chongqingMapFullscreen) {
      chongqingMapCard.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'flex';
      });
    }

    if (closeChongqingMap) {
      closeChongqingMap.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'none';
      });
    }

    window.addEventListener('resize', function() {
      if (matrixRainCanvas && matrixRainFullscreen.style.display === 'flex') {
        matrixRainCanvas.width = window.innerWidth;
        matrixRainCanvas.height = window.innerHeight;
        const columns = Math.floor(matrixRainCanvas.width / 20);
        if (drops.length !== columns) {
          drops.length = 0;
          for (let i = 0; i < columns; i++) {
            drops[i] = 1 + Math.random() * matrixRainCanvas.height / 20;
          }
        }
      }
      const archiveSection = document.getElementById('archive-section');
      if (archiveSection && archiveSection.style.display !== 'none') {
        if (typeof initGradesChart === 'function') initGradesChart();
        if (typeof initCoursesChart === 'function') initCoursesChart();
      }
    });
  });

  // --- 你已有的其他 DOMContentLoaded 逻辑，如导航等 ---
  var showBtn = document.getElementById('show-leave-btn');
  var leaveSection = document.getElementById('leave-section');
  if(showBtn && leaveSection) {
    showBtn.addEventListener('click', function() {
      showBtn.style.display = 'none';
      leaveSection.style.display = 'block';
    });
  }

  // --- 你已有的全局函数 ---
  function showGames(){}
  function showSearch(){}
  function showProfile(){
    document.getElementById("profile-section").style.display = "block";
    document.getElementById("chat-section").style.display = "none";
    document.getElementById("leave-section").style.display = "none";
    document.querySelector('.menu').style.display = 'flex';
    
    // 确保个人信息和树的状态正确
    const personalInfoWrapper = document.getElementById('personal-info-wrapper');
    const treeEmbed = document.getElementById('tree-of-life-embed');
    if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
    if (treeEmbed) treeEmbed.style.display = 'block';
  }

  function showChat() {
    document.getElementById("chat-section").style.display = "block";
    document.getElementById("leave-section").style.display = "block";
    document.getElementById("profile-section").style.display = "none";
    
    // 确保个人信息和树的状态正确
    const personalInfoWrapper = document.getElementById('personal-info-wrapper');
    const treeEmbed = document.getElementById('tree-of-life-embed');
    if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
    if (treeEmbed) treeEmbed.style.display = 'none';
  }

  const navChatButton = document.getElementById('nav-chat');
  if (navChatButton) {
    navChatButton.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      document.getElementById('chat-section').style.display = 'block';
      const leaveSectionDiv = document.getElementById('leave-section');
      if (leaveSectionDiv) {
        leaveSectionDiv.style.display = 'none';
      }
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
    });
  }

  const navRepoButton = document.getElementById('nav-repo');
  if (navRepoButton) {
    navRepoButton.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      const repoSection = document.getElementById('repo-section');
      if (repoSection) repoSection.style.display = 'block';
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
    });
  }

  // 导航栏点击事件
  document.querySelectorAll('.menu .link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      // 切换高亮
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
      
      // 切换内容区
      const target = this.getAttribute('data-target');
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      
      if(target === 'chat-section') {
        document.getElementById('chat-section').style.display = 'block';
        // 确保个人信息和树的状态正确
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
        if (treeEmbed) treeEmbed.style.display = 'none';
      } else if(target === 'profile-section') {
        document.getElementById('profile-section').style.display = 'block';
        // 确保个人信息和树的状态正确
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
        if (treeEmbed) treeEmbed.style.display = 'block';
      } else {
        document.getElementById(target).style.display = 'block';
        // 确保个人信息和树的状态正确
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
        if (treeEmbed) treeEmbed.style.display = 'none';
      }
      
      // 显示底部菜单
      document.getElementById("bottom-menu").style.display = "flex";
    });
  });

  const audio = document.getElementById('navbar-audio');
  if (audio) {
    audio.play().then(() => {
      if (musicToggle) musicToggle.checked = true;
      if (navbarSpectrumCanvas) navbarSpectrumCanvas.style.display = 'block';
      if (typeof setupAudioVisualizer === 'function') setupAudioVisualizer();
    }).catch(() => {
      document.body.addEventListener('click', function oncePlay() {
        audio.play();
        if (musicToggle) musicToggle.checked = true;
        if (navbarSpectrumCanvas) navbarSpectrumCanvas.style.display = 'block';
        if (typeof setupAudioVisualizer === 'function') setupAudioVisualizer();
        document.body.removeEventListener('click', oncePlay);
      });
    });
  }

  // 添加仓库卡片的点击事件处理
  const matrixRainCard = document.getElementById('matrix-rain-card');
  const chongqingMapCard = document.getElementById('chongqing-map-card');
  const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
  const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
  const closeMatrixRain = document.getElementById('close-matrix-rain');
  const closeChongqingMap = document.getElementById('close-chongqing-map');

  if (matrixRainCard && matrixRainFullscreen) {
    matrixRainCard.addEventListener('click', function() {
      matrixRainFullscreen.style.display = 'flex';
      initMatrixRain();
    });
  }

  if (closeMatrixRain) {
    closeMatrixRain.addEventListener('click', function() {
      matrixRainFullscreen.style.display = 'none';
      stopMatrixRain();
    });
  }

  if (chongqingMapCard && chongqingMapFullscreen) {
    chongqingMapCard.addEventListener('click', function() {
      chongqingMapFullscreen.style.display = 'flex';
    });
  }

  if (closeChongqingMap) {
    closeChongqingMap.addEventListener('click', function() {
      chongqingMapFullscreen.style.display = 'none';
    });
  }

  // 矩阵雨动画相关变量和函数
  let matrixRainCanvas, matrixRainCtx, matrixRainInterval;
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
  const drops = [];

  function initMatrixRain() {
    matrixRainCanvas = document.getElementById('matrix-rain-canvas');
    if (!matrixRainCanvas) return;
    
    matrixRainCtx = matrixRainCanvas.getContext('2d');
    matrixRainCanvas.width = window.innerWidth;
    matrixRainCanvas.height = window.innerHeight;
    
    const columns = Math.floor(matrixRainCanvas.width / 20);
    for (let i = 0; i < columns; i++) {
      drops[i] = 1;
    }
    
    if (matrixRainInterval) clearInterval(matrixRainInterval);
    matrixRainInterval = setInterval(drawMatrixRain, 33);
  }

  function drawMatrixRain() {
    matrixRainCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    matrixRainCtx.fillRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
    
    matrixRainCtx.fillStyle = '#0F0';
    matrixRainCtx.font = '15px monospace';
    
    for (let i = 0; i < drops.length; i++) {
      const text = chars[Math.floor(Math.random() * chars.length)];
      matrixRainCtx.fillText(text, i * 20, drops[i] * 20);
      
      if (drops[i] * 20 > matrixRainCanvas.height && Math.random() > 0.975) {
        drops[i] = 0;
      }
      drops[i]++;
    }
  }

  function stopMatrixRain() {
    if (matrixRainInterval) {
      clearInterval(matrixRainInterval);
      matrixRainInterval = null;
    }
    if (matrixRainCtx) {
      matrixRainCtx.clearRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
    }
  }

  // 页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 添加仓库卡片的点击事件处理
    const matrixRainCard = document.getElementById('matrix-rain-card');
    const chongqingMapCard = document.getElementById('chongqing-map-card');
    const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
    const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
    const closeMatrixRain = document.getElementById('close-matrix-rain');
    const closeChongqingMap = document.getElementById('close-chongqing-map');

    if (matrixRainCard && matrixRainFullscreen) {
      matrixRainCard.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'flex';
        initMatrixRain();
      });
    }

    if (closeMatrixRain) {
      closeMatrixRain.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'none';
        stopMatrixRain();
      });
    }

    if (chongqingMapCard && chongqingMapFullscreen) {
      chongqingMapCard.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'flex';
      });
    }

    if (closeChongqingMap) {
      closeChongqingMap.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'none';
      });
    }

    // 监听窗口大小变化
    window.addEventListener('resize', function() {
      if (matrixRainCanvas) {
        matrixRainCanvas.width = window.innerWidth;
        matrixRainCanvas.height = window.innerHeight;
      }
    });
  });

  // 导航相关函数
  function showGames() {}
  function showSearch() {}
  
  function showProfile() {
    document.getElementById("profile-section").style.display = "block";
    document.getElementById("chat-section").style.display = "none";
    document.getElementById("leave-section").style.display = "none";
    document.querySelector('.menu').style.display = 'flex';
  }

  function showChat() {
    document.getElementById("chat-section").style.display = "block";
    document.getElementById("leave-section").style.display = "block";
    document.getElementById("profile-section").style.display = "none";
  }

  // 监听窗口大小变化
  window.addEventListener('resize', function() {
    if (matrixRainCanvas) {
      matrixRainCanvas.width = window.innerWidth;
      matrixRainCanvas.height = window.innerHeight;
    }
  });

</script>

<!-- 新增缺失的内容区 -->
<div id="repo-section" class="page-section" style="display:none;">
  <div style="display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:flex-start;gap:32px;padding:40px 15px;width:100%;box-sizing:border-box;height:100%;overflow-y:auto;">
    <!-- 矩阵雨卡片 -->
    <div class="container-card-charts" id="matrix-rain-card" style="cursor:pointer;width:48%;">
      <div class="card-charts" style="position:relative;overflow:hidden;height:100%;">
        <div class="tags-card">
          <span class="name" style="font-size:16px;font-weight:bold;">矩阵雨</span>
        </div>
        <div class="main-texts">
          <p class="title">Matrix Rain</p>
          <p class="change">点击体验全屏动画</p>
        </div>
        <canvas id="matrix-rain-thumb" width="260" height="120" style="width:90%;height:120px;display:block;margin:0 auto;border-radius:12px;"></canvas>
      </div>
    </div>
    <!-- 重庆地图卡片 -->
    <div class="container-card-charts" id="chongqing-map-card" style="cursor:pointer;width:48%;">
      <div class="card-charts" style="position:relative;overflow:hidden;height:100%;">
        <div class="tags-card">
          <span class="name" style="font-size:16px;font-weight:bold;">重庆地图</span>
        </div>
        <div class="main-texts">
          <p class="title">重庆</p>
          <p class="change">点击查看高校位置</p>
        </div>
        <svg width="120" height="120" viewBox="0 0 120 120" style="display:block;margin:0 auto;">
          <path d="M60,10 Q80,20 90,40 Q110,60 80,80 Q60,110 40,90 Q10,80 30,60 Q20,40 40,20 Q50,10 60,10 Z" fill="#e57373" stroke="#b71c1c" stroke-width="2"/>
          <text x="60" y="70" text-anchor="middle" fill="#fff" font-size="22" font-family="monospace">重庆</text>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- 全屏矩阵雨弹窗 -->
<div id="matrix-rain-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#000;align-items:center;justify-content:center;">
  <canvas id="matrix-rain-canvas" style="width:100vw;height:100vh;display:block;"></canvas>
  <button id="close-matrix-rain" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">关闭</button>
</div>

<!-- 全屏重庆地图弹窗（iframe嵌入lab4.htm） -->
<div id="chongqing-map-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#18181a;align-items:center;justify-content:center;flex-direction:column;">
  <button id="close-chongqing-map" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">关闭</button>
  <iframe src="lab4.htm" width="100%" height="100%" style="border:none;background:#fff;"></iframe>
</div>

<div id="archive-section" class="page-section" style="display:none;">
  <div class="center-content">
    <h2 style="color: #4f46e5; margin-bottom: 30px; text-align: center; width: 100%;">我的成就</h2>
    <div class="charts-container" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%;">
      <div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
        <div style="display: flex; flex-direction: column; align-items: center; min-width: 340px; flex: 1;">
          <h3 style="color: #333; margin-bottom: 20px;">成绩等级分布</h3>
          <svg id="grades-chart" width="340" height="340" style="display: block; margin: 0 auto; max-width: 100%;"></svg>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; min-width: 400px; flex: 1;">
          <h3 style="color: #333; margin-bottom: 20px;">课程成绩分布</h3>
          <svg id="courses-chart" width="400" height="400" style="display: block; margin: 0 auto; max-width: 100%;"></svg>
        </div>
      </div>
    </div>
    <!-- 项目展示 -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
      <!-- FPGA项目 -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">FPGA项目</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">本人主要聚焦于频综设计、射频控制、传感器监测、远程无线操控、接口设计等FPGA应用方向，代码由于涉密原因，无法全部公开，若需要了解具体项目内容，可以在留言区留下联系方式。</p>
        </div>
        <a href="https://github.com/Metalphon/Sandalphon/tree/main" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          查看GitHub源码
        </a>
      </div>
      <!-- 单片机项目 -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">单片机项目</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">本人主要聚焦于传感器监测，射频控制，嵌入式项目设计等方向，主要使用stm32，对ti单片机，51单片机，合泰单片机也有少数项目，代码由于涉密原因，无法全部公开，若需要了解具体项目内容，可以在留言区留下联系方式。</p>
        </div>
        <a href="https://github.com/Metalphon/stm32_project" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          查看GitHub源码
        </a>
      </div>
      <!-- Python项目 -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">Python项目</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">本人主要聚焦于串口控制，网口控制，上位机界面编写，摄像头控制，爬虫实践等python和micropython方向，代码由于部分涉密，另一部分侵权，无法公开，若需要了解具体项目内容，可以在留言区留下联系方式。</p>
        </div>
        <a href="https://github.com/Metalphon/lot" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          查看GitHub源码
        </a>
      </div>
      <!-- Web项目 -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">Web项目</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">包括个人简历网站、数据可视化展示等，前端后端均有涉及。如需了解具体项目内容，请留言联系。</p>
        </div>
        <a href="https://github.com/Metalphon/visual" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          查看GitHub源码
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// 成绩饼图
function initGradesChart() {
  const svg = d3.select("#grades-chart");
  svg.selectAll("*").remove();
  const width = 340, height = 340, radius = 140;
  const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
  const color = d3.scaleOrdinal().range(['#4f46e5','#6366f1','#818cf8','#a5b4fc']);
  const data = getGradeLevelData();
  const pie = d3.pie().value(d=>d.value).sort(null);
  const arc = d3.arc().innerRadius(radius*0.6).outerRadius(radius);
  const arcs = g.selectAll("arc").data(pie(data)).enter().append("g");

  // 添加中心提示文字
  const centerText = g.append("text")
    .attr("class","tooltip")
    .style("opacity",0)
    .attr("text-anchor","middle")
    .attr("alignment-baseline","middle")
    .style("white-space","pre")
    .style("font-size","18px")
    .style("font-weight","bold")
    .style("fill","#4f46e5");

  arcs.append("path")
    .attr("d", arc)
    .attr("fill", (d,i)=>color(i))
    .style("transition","all 0.3s")
    .on("mouseover", function(event, d) {
      centerText.text(`${d.data.name}\n${d.data.value}门`).style("opacity",1);
      d3.select(this).style("transform","scale(1.05)").style("filter","brightness(1.1)");
    })
    .on("mouseout", function() {
      centerText.style("opacity",0);
      d3.select(this).style("transform","scale(1)").style("filter","none");
    });

  arcs.append("text")
    .attr("transform", d=>`translate(${arc.centroid(d)})`)
    .attr("class","label")
    .text(d=>d.data.value>0?d.data.name:"")
    .style("fill","white")
    .style("font-size","16px")
    .style("text-anchor","middle");
}

// 课程成绩饼图
function initCoursesChart() {
  const svg = d3.select("#courses-chart");
  svg.selectAll("*").remove();
  const width = 400, height = 400, radius = 180; 
  const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
  const color = d3.scaleOrdinal().range([
    '#4f46e5', // 高等数学
    '#6366f1', // 线性代数
    '#f59e42', // 概率论
    '#a5b4fc', // 信号与系统
    '#c7d2fe', // 工程电磁场
    '#f472b6', // 现代编码技术
    '#34d399', // 模拟电子技术
    '#fbbf24', // 数字电子技术
    '#10b981', // 高频电子线路
    '#f87171', // 微机原理
    '#60a5fa', // 可编程器件原理
    '#a3e635', // 虚拟显示技术
    '#8b5cf6'  // 智能数据分析程序设计
  ]);
  const data = courseData.sort((a, b) => b.value - a.value); 
  const pie = d3.pie().value(d=>d.value).sort(null);
  // 加厚环形图
  const arc = d3.arc().innerRadius(radius * 0.35).outerRadius(radius);
  const arcs = g.selectAll("arc").data(pie(data)).enter().append("g");

  arcs.append("path")
    .attr("d", arc)
    .attr("fill", (d,i)=>color(i))
    .style("transition","all 0.3s")
    .on("mouseover", function(event, d) {
      centerText.text(`${d.data.name}\n${d.data.value}分`).style("opacity",1);
      d3.select(this).style("transform","scale(1.05)").style("filter","brightness(1.1)");
    })
    .on("mouseout", function() {
      centerText.style("opacity",0);
      d3.select(this).style("transform","scale(1)").style("filter","none");
    });

  const centerText = g.append("text")
    .attr("class","tooltip")
    .style("opacity",0)
    .attr("text-anchor","middle")
    .attr("alignment-baseline","middle")
    .style("white-space","pre")
    .style("font-size","16px")
    .style("font-weight","bold")
    .style("fill","#4f46e5");

  // 优化标签换行和字体
  arcs.append("text")
    .attr("transform", d => {
      const pos = arc.centroid(d);
      return `translate(${pos})`;
    })
    .attr("class","label")
    .selectAll("tspan")
    .data(d => {
      const name = d.data.name;
      // 技术类优先在"技术"前换行
      if (name.length > 6 && name.includes('技术')) {
        const arr = name.split('技术');
        return arr.length === 2 ? [arr[0], '技术'] : [name];
      } else if (name.length > 8) {
        let breakPoint = Math.floor(name.length / 2);
        if (name.length > 10) breakPoint = 5;
        if (breakPoint > 0 && breakPoint < name.length -1 && /[\u4e00-\u9fa5]/.test(name[breakPoint-1]) && /[\u4e00-\u9fa5]/.test(name[breakPoint])) {
          return [name.substring(0, breakPoint), name.substring(breakPoint)];
        }
      }
      return [name];
    })
    .enter().append("tspan")
    .attr("x", 0)
    .attr("dy", (d, i) => i === 0 ? 0 : "1.2em")
    .text(d => d)
    .style("fill","white")
    .style("font-size","10px")
    .style("text-anchor","middle")
    .style("pointer-events","none");
}

// 在成就页面显示时初始化图表
document.getElementById('nav-archive').addEventListener('click', function() {
  setTimeout(() => {
    initGradesChart();
    initCoursesChart();
  }, 100);
});

// 监听窗口大小变化
window.addEventListener('resize', function() {
  if (document.getElementById('archive-section').style.display === 'block') {
    initGradesChart();
    initCoursesChart();
  }
});

// 课程成绩数据
const courseData = [
  { name: '高等数学', value: 83 },
  { name: '线性代数', value: 96 },
  { name: '概率论', value: 83 },
  { name: '信号与系统', value: 76 },
  { name: '工程电磁场', value: 80 },
  { name: '现代编码技术', value: 91 },
  { name: '模拟电子技术', value: 88 },
  { name: '数字电子技术', value: 87 },
  { name: '高频电子线路', value: 87 },
  { name: '微机原理', value: 83 },
  { name: '可编程器件原理', value: 90 },
  { name: '虚拟显示技术', value: 83 },
  { name: '智能数据分析程序设计', value: 90 }
];

// 统计成绩等级分布
function getGradeLevelData() {
  let excellent = 0, good = 0, medium = 0, pass = 0;
  courseData.forEach(d => {
    if (d.value >= 90) excellent++;
    else if (d.value >= 80) good++;
    else if (d.value >= 70) medium++;
    else if (d.value >= 60) pass++;
  });
  return [
    { name: '优秀', value: excellent },
    { name: '良好', value: good },
    { name: '中等', value: medium },
    { name: '及格', value: pass }
  ];
}
</script>

<style>
#profile-section #tree-of-life-embed .container {
  max-width: 100vw;
  padding: 0;
  background: #fff;
}
#profile-section #tree-of-life-embed h1 {
  font-size: 2.2rem;
  color: #4f46e5;
  margin-bottom: 1.2rem;
}
#profile-section #tree-of-life-embed svg {
  background: #f8f4e8 !important;
}
</style>

<!-- 全屏比特币K线弹窗 -->
<div id="btc-kline-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#18181a;align-items:center;justify-content:center;flex-direction:column;">
  <button id="close-btc-kline" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">关闭</button>
  <div id="btc-kline-chart" style="width:90vw;height:80vh;background:#fff;border-radius:12px;"></div>
</div>
