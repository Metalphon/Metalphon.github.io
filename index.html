<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç‹å®¶ç¿çš„ç•™è¨€æ¿ä¸ç®€ä»‹</title> <!-- ä¿®æ”¹æ ‡é¢˜ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // æ·»åŠ å…¨å±€æ’­æ”¾æ§åˆ¶å˜é‡
    window.hasAutoPlayedOnce = false;
    window.isUserPaused = false;
    window.oncePlayOnBodyHandler = null;
    window.spectrumAnimationId = null;
    window.audioContext = null;
    window.analyser = null;
    window.dataArray = null;

    const firebaseConfig = {
      apiKey: "AIzaSyAYftoevTnczZimCLzzJujqFqBXcReMvt8",
      authDomain: "metalphon-7ed49.firebaseapp.com",
      projectId: "metalphon-7ed49",
      storageBucket: "metalphon-7ed49.appspot.com",
      messagingSenderId: "965453822169",
      appId: "1:965453822169:web:8ea6ec693243af8892e6c8",
      measurementId: "G-Y6LN2HHHH7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentUser = null;
    let loadingAnimationElement = null;

    function showLoading() {
      if (loadingAnimationElement) loadingAnimationElement.style.display = "flex";
    }

    function hideLoading() {
      if (loadingAnimationElement) loadingAnimationElement.style.display = "none";
    }

    function showLogin() {
      document.getElementById("welcome-section").style.display = "block";
      document.getElementById("profile-section").style.display = "none";
      document.getElementById("leave-section").style.display = "none";
      document.getElementById("matrix-bg").style.display = "block";
      document.querySelector('.menu').style.display = 'none';
    }

    function initializeTreeIfNeeded() {
      // å¯é€‰ï¼šå¦‚æœiframeæ‡’åŠ è½½ï¼Œå¯åœ¨æ­¤å¤„åŠ¨æ€åŠ è½½
    }

    window.startChat = () => {
      // 1. è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
      const audio = document.getElementById('navbar-audio');
      const musicToggle = document.getElementById('music-toggle');
      const navbarSpectrum = document.getElementById('navbar-spectrum');
      
      if (audio && !window.hasAutoPlayedOnce && !window.isUserPaused) {
        audio.play().then(() => {
          if (musicToggle) musicToggle.checked = true;
          if (navbarSpectrum) navbarSpectrum.style.display = 'block';
          window.hasAutoPlayedOnce = true;
          if (typeof window.initAudioAnalyserGlobal === 'function') {
            window.initAudioAnalyserGlobal(audio);
            window.drawSpectrumGlobal(navbarSpectrum);
          }
        }).catch(() => {
          // è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢æ—¶ï¼Œæ·»åŠ ä¸€æ¬¡æ€§ç‚¹å‡»äº‹ä»¶
          if (!window.isUserPaused && !window.oncePlayOnBodyHandler) {
            window.oncePlayOnBodyHandler = () => {
              audio.play().then(() => {
                if (musicToggle) musicToggle.checked = true;
                if (navbarSpectrum) navbarSpectrum.style.display = 'block';
                window.hasAutoPlayedOnce = true;
                if (typeof window.initAudioAnalyserGlobal === 'function') {
                  window.initAudioAnalyserGlobal(audio);
                  window.drawSpectrumGlobal(navbarSpectrum);
                }
              }).catch(() => {});
              document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
              window.oncePlayOnBodyHandler = null;
            };
            document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
          }
        });
      }
      // --- END ---
      const nameInput = document.getElementById("nickname").value.trim();
      if (nameInput) {
        document.getElementById("personal-info-wrapper").style.display = "none";
        document.getElementById("tree-of-life-embed").style.display = "block";
        initializeTreeIfNeeded();
        currentUser = nameInput;
        document.getElementById("welcome-section").style.display = "none";
        document.getElementById("profile-section").style.display = "block";
        document.querySelectorAll('.page-section').forEach(sec => {
          if (sec.id !== 'profile-section') {
            sec.style.display = 'none';
          }
        });
        const leaveSectionDiv = document.getElementById("leave-section");
        if (leaveSectionDiv) {
          leaveSectionDiv.style.display = "none";
        }
        const mainChatWelcomeName = document.querySelector('#chat-section.page-section #welcome-name');
        if(mainChatWelcomeName) mainChatWelcomeName.textContent = currentUser;
        if (!loadingAnimationElement) {
            loadingAnimationElement = document.getElementById("loading-animation");
        }
        loadMessages();
        document.getElementById("bottom-menu").style.display = "flex";
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        const navHome = document.getElementById('nav-home');
        if (navHome) navHome.classList.add('active');
        if (window.showMusicPlayer) {
            window.showMusicPlayer();
        }
      } else {
        alert("è¯·è¾“å…¥ä½ çš„æ˜µç§°ï¼");
      }
    };

    window.submitMessage = async () => {
      const input = document.getElementById("message-input");
      const message = input.value.trim();

      if (!currentUser) {
        alert("è¯·å…ˆè¿›å…¥ç•™è¨€æ¿ï¼ˆè®¾ç½®æ˜µç§°ï¼‰ã€‚");
        return;
      }
      if (!message) {
        alert("ç•™è¨€å†…å®¹ä¸èƒ½ä¸ºç©ºï¼");
        return;
      }

      showLoading(); 
      const messagesContainer = document.getElementById("messages");
      messagesContainer.innerHTML = ''; 

      try {
        await addDoc(collection(db, "messages"), {
          user: currentUser,
          content: message,
          timestamp: serverTimestamp() 
        });
        input.value = "";
      } catch (error) {
        console.error("Error adding document: ", error);
        alert("å‘é€ç•™è¨€å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯ã€‚");
        hideLoading(); 
      } finally {
        loadMessages(); 
      }
    };

    window.loadMessages = async () => {
      const container = document.getElementById("messages");
      showLoading(); 

      try {
        const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        let html = "";
        if (querySnapshot.empty) {
          html = "<p>è¿˜æ²¡æœ‰ç•™è¨€ï¼Œå¿«æ¥æŠ¢æ²™å‘å§ï¼</p>";
        } else {
          querySnapshot.forEach((doc) => {
            const data = doc.data();
            const date = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate().toLocaleString('zh-CN') : 'å‘é€ä¸­...'; // ä½¿ç”¨ä¸­æ–‡åŒºåŸŸè®¾ç½®
            html += `
              <div class="message-item">
                <strong class="message-user">${data.user || "åŒ¿å"}</strong>
                <span class="message-timestamp">(${date})</span>ï¼š
                <span class="message-content">${data.content}</span>
              </div>
            `;
          });
        }
        container.innerHTML = html;
      } catch (error) {
        console.error("Error loading messages: ", error);
        container.innerHTML = "<p style='color:red;'>åŠ è½½ç•™è¨€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚</p>";
      } finally {
        hideLoading(); 
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
        loadingAnimationElement = document.getElementById("loading-animation");
        // ç™»å½•é¡µæ—¶éšè—åº•éƒ¨èœå•
        document.getElementById("bottom-menu").style.display = "none";
        // åˆ‡æ¢å†…å®¹åŒºæ—¶æ˜¾ç¤ºåº•éƒ¨èœå•
        const links = document.querySelectorAll('.menu .link');
        links.forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            // åˆ‡æ¢é«˜äº®
            links.forEach(l => l.classList.remove('active'));
            this.classList.add('active');
            // åˆ‡æ¢å†…å®¹åŒº
            const target = this.getAttribute('data-target');
            document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
            if(target === 'chat-section') {
              document.getElementById('chat-section').style.display = 'block';
            } else {
              document.getElementById(target).style.display = 'block';
            }
            // æ˜¾ç¤ºåº•éƒ¨èœå•
            document.getElementById("bottom-menu").style.display = "flex";
          });
        });
    });

  </script>

  <style>
    body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Segoe UI', 'Arial', sans-serif;
    }
    .center-bg {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .form, .card {
      width: 100vw !important;
      max-width: 100vw !important;
      min-height: 100vh !important;
      margin: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
      background: transparent !important;
      padding: 40px 0 !important;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      box-sizing: border-box;
    }
    .form > p {
      color: var(--font-color);
      font-weight: 700;
      font-size: 20px;
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .form > p > span {
      color: var(--font-color-sub);
      font-weight: 600;
      font-size: 17px;
    }
    .separator {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .separator > div {
      width: 100px;
      height: 3px;
      border-radius: 5px;
      background-color: var(--font-color-sub);
    }
    .separator > span {
      color: var(--font-color);
      font-weight: 600;
    }
    .oauthButton {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      width: 250px;
      height: 40px;
      border-radius: 5px;
      border: 2px solid var(--main-color);
      background-color: var(--bg-color);
      box-shadow: 4px 4px var(--main-color);
      font-size: 16px;
      font-weight: 600;
      color: var(--font-color);
      cursor: pointer;
      transition: all 250ms;
      position: relative;
      overflow: hidden;
      z-index: 1;
      padding: 0 15px;
    }
    .oauthButton::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0;
      background-color: #212121;
      z-index: -1;
      box-shadow: 4px 8px 19px -3px rgba(0, 0, 0, 0.27);
      transition: all 250ms;
    }
    .oauthButton:hover {
      color: #e8e8e8;
    }
    .oauthButton:hover::before {
      width: 100%;
    }
    .form > input {
      width: 250px;
      height: 40px;
      border-radius: 5px;
      border: 2px solid var(--main-color);
      background-color: var(--bg-color);
      box-shadow: 4px 4px var(--main-color);
      font-size: 15px;
      font-weight: 600;
      color: var(--font-color);
      padding: 5px 10px;
      outline: none;
    }
    .icon {
      width: 1.5rem;
      height: 1.5rem;
    }
    .hero-bg {
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      position: fixed;
      top: 0; left: 0;
      z-index: 0;
    }
    .hero-card {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.18);
      padding: 3rem 2.5rem 2.5rem 2.5rem;
      text-align: center;
      max-width: 420px;
      width: 100%;
      animation: fadeInUp 1s;
      z-index: 1;
    }
    .avatar {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      margin-bottom: 1.2rem;
      box-shadow: 0 2px 8px rgba(99,102,241,0.18);
      border: 4px solid #a5b4fc;
      object-fit: cover;
    }
    h1 {
      font-size: 2.2rem;
      color: #4f46e5;
      margin-bottom: 0.5rem;
      font-weight: 800;
      letter-spacing: 1px;
    }
    .subtitle {
      font-size: 1.1rem;
      color: #6366f1;
        margin-bottom: 0.8rem;
    }
    .intro {
        color: #374151;
      margin-bottom: 1.5rem;
      font-size: 1rem;
    }
    .input-label {
        display: block;
        margin-bottom: 0.5rem;
        color: #333;
        font-weight: bold;
        text-align: left;
    }
    .input, #messages {
      width: 90vw !important;
      max-width: 900px;
    }
    .input:focus {
        border-color: #4f46e5;
        outline: none;
        box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
    }
    .btn {
      background: linear-gradient(90deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      padding: 10px 20px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background 0.2s, transform 0.2s;
      box-shadow: 0 2px 8px rgba(99,102,241,0.12);
    }
    .btn:hover {
      background: linear-gradient(90deg, #4f46e5 0%, #6366f1 100%);
      transform: translateY(-2px) scale(1.04);
    }
    .btn:active {
        background: #3730a3;
    }
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(40px);}
      to { opacity: 1; transform: translateY(0);}
    }
    /* è®©åç»­å†…å®¹ä¸å—å…¨å±èƒŒæ™¯å½±å“ */
    #profile-section, #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 2;
      padding: 40px 0;
      box-sizing: border-box;
    }
    #chat-section {
      background: rgba(255,255,255,0.98);
    }
    #profile-section > *, #chat-section > * {
      width: 90vw;
      max-width: 900px;
    }
    .card {
      width: 100%;
      max-width: 600px; 
      margin: 1rem auto;
      background: white;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    /* ç®€ä»‹éƒ¨åˆ†çš„ç‰¹å®šæ ·å¼ */
    #profile-section h2 {
        color: #4f46e5; /* ä¸æŒ‰é’®é¢œè‰²å‘¼åº” */
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }
    #profile-section p {
        margin-bottom: 0.8rem;
        line-height: 1.6;
        color: #374151;
    }
    #profile-section strong {
        color: #1f2937;
    }

    #messages {
        margin-top: 1.5rem;
        max-height: 300px; /* è°ƒæ•´é«˜åº¦ä¸ºç®€ä»‹è…¾å‡ºç©ºé—´ */
        overflow-y: auto; 
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        background-color: #f9fafb;
        min-height: 50px; 
    }

    .message-item {
      margin-bottom: 1.5rem;
      padding: 0.75rem;
      border-radius: 0.5rem;
      background-color: #ffffff; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border-left: 4px solid #4f46e5; 
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    .message-user {
        font-weight: bold;
        color: #374151;
    }
    .message-timestamp {
        font-size: 0.8rem;
        color: #6b7280;
        margin-left: 0.5rem;
    }
    .message-content {
        display: block; 
        margin-top: 0.25rem;
        color: #1f2937;
        word-wrap: break-word; 
    }

    /* Loading Animation Styles */
    .loader {
      --ANIMATION-DELAY-MULTIPLIER: 70ms;
      padding: 0;
      margin: 20px auto; 
      display: none; 
      flex-direction: row;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      height: 50px; 
    }
    .loader span {
      padding: 0;
      margin: 0 2px; /* å¢åŠ å­—æ¯é—´è· */
      letter-spacing: 0; /* ä¿®æ”¹ä¸º0ï¼Œä¸å†æŒ¤åœ¨ä¸€èµ· */
      animation-delay: 0s;
      transform: translateY(4rem);
      animation: hideAndSeek 1s alternate infinite cubic-bezier(0.86, 0, 0.07, 1);
    }
    .loader .l { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 0); }
    .loader .o { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 1); }
    .loader .a { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 2); }
    .loader .d { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 3); }
    .loader .ispan { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 4); }
    .loader .n { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 5); }
    .loader .g { animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 6); }
    .letter { width: fit-content; height: 3rem; }
    .ispan .letter { margin-inline: 5px; }
    @keyframes hideAndSeek {
      0% { transform: translateY(4rem); }
      100% { transform: translateY(0rem); }
    }

    #particles-js {
      position: absolute;
      width: 100vw;
      height: 100vh;
      top: 0; left: 0;
      z-index: 0;
    }
    .hero-card {
      position: relative;
      z-index: 2;
    }
    .hero-bg {
      position: relative;
      z-index: 1;
    }
    .pixel-bg {
      position: fixed;
      width: 100vw;
      height: 100vh;
      left: 0; top: 0;
      pointer-events: none;
      z-index: 0;
    }
    .pixel-board {
      position: absolute;
      opacity: 0.7;
    }
    .pixel-board-tl { left: 2vw; top: 2vh; transform: rotate(-10deg);}
    .pixel-board-br { right: 2vw; bottom: 2vh; transform: rotate(12deg);}
    .pixel-board-tr { right: 8vw; top: 8vh; transform: rotate(6deg);}
    .pixel-board-bl { left: 8vw; bottom: 8vh; transform: rotate(-7deg);}
    .chip-wall-bg, .chip-wall-grid, .chip-svg { display: none !important; }
    #matrix-bg {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none;
      background: #000;
      opacity: 1;
    }
    .center-bg, .form, #welcome-section, #profile-section, #chat-section {
      position: relative;
      z-index: 1;
    }
    /* å¼¹çª—æ ·å¼ï¼ˆå…¨å±è¦†ç›–ï¼‰ */
    #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.98);
      border-radius: 0;
      box-shadow: none;
      z-index: 1000;
      display: none;
      overflow: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #profile-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: #fff !important;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .menu {
      position: fixed;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      padding: 0.5rem 1.5rem;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(8px);
      display: flex;
      justify-content: center;
      border-radius: 15px;
      box-shadow: 0 10px 25px 0 rgba(0,0,0,0.075);
      z-index: 2000;
    }
    .link {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      width: 70px;
      height: 50px;
      border-radius: 8px;
      position: relative;
      z-index: 1;
      overflow: hidden;
      transform-origin: center left;
      transition: width 0.2s ease-in;
      text-decoration: none;
      color: inherit;
      background: transparent;
    }
    .link:before {
      position: absolute;
      z-index: -1;
      content: "";
      display: block;
      border-radius: 8px;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      transform: translateX(100%);
      transition: transform 0.2s ease-in;
      transform-origin: center right;
      background-color: #eee;
    }
    .link:hover,
    .link:focus {
      outline: 0;
      width: 130px;
    }
    .link:hover:before,
    .link:focus:before,
    .link:hover .link-title,
    .link:focus .link-title {
      transform: translateX(0);
      opacity: 1;
    }
    .link-icon {
      width: 28px;
      height: 28px;
      display: block;
      flex-shrink: 0;
      left: 18px;
      position: absolute;
    }
    .link-icon svg {
      width: 28px;
      height: 28px;
    }
    .link-title {
      transform: translateX(100%);
      transition: transform 0.2s ease-in;
      transform-origin: center right;
      display: block;
      text-align: center;
      text-indent: 28px;
      width: 100%;
    }
    /* æ¢å¤ç™»å½•ç•Œé¢.formå¡ç‰‡æ ·å¼ */
    .form {
      padding: 24px 18px;
      background: #ede9fe !important;
      border-radius: 22px;
      border: 1.5px solid #e0e7ef;
      box-shadow: 0 6px 32px 0 rgba(99,102,241,0.06), 0 1.5px 0 #e0e7ef inset;
      max-width: 320px;
      width: 100%;
      margin: 60px auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 18px;
      transition: box-shadow 0.2s, border 0.2s;
    }
    .form:focus-within, .form:hover {
      box-shadow: 0 8px 40px 0 rgba(99,102,241,0.10), 0 2px 0 #b3bcf5 inset;
      border-color: #b3bcf5;
    }
    #profile-section, #chat-section {
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 2;
      padding: 40px 0;
      box-sizing: border-box;
    }
    #profile-section {
      background: #fff !important;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.08);
    }
    #chat-section {
      background: rgba(255,255,255,0.98);
    }
    #profile-section > *, #chat-section > * {
      width: 90vw;
      max-width: 900px;
    }
    /* From Uiverse.io by Praashoo7 */
    .input {
      border: none;
      outline: none;
      border-radius: 15px;
      padding: 1em;
      background-color: #ccc;
      box-shadow: inset 2px 5px 10px rgba(0,0,0,0.3);
      transition: 300ms ease-in-out;
    }
    .input:focus {
      background-color: white;
      transform: scale(1.05);
      box-shadow: 13px 13px 100px #969696,
                 -13px -13px 100px #ffffff;
    }
    .chat-flex {
      display: flex;
      width: 90vw;
      max-width: 1100px;
      height: 70vh;
      min-height: 400px;
      margin: 0 auto;
      background: transparent;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0,0,0,0.04);
      overflow: hidden;
    }
    .chat-input-area, .chat-messages-area {
      flex: 1 1 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: #f8fafc;
      padding: 2.5rem 2rem;
      box-sizing: border-box;
    }
    .chat-input-area {
      border-right: 1.5px solid #e5e7eb;
      align-items: center;
    }
    .chat-input-area h2,
    .chat-input-area label,
    .chat-input-area input,
    .chat-input-area button,
    .chat-input-area .loader {
      width: 100%;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .chat-messages-area {
      flex: 1 1 0;
      height: 100%;
      min-height: 0;
      display: flex;
      flex-direction: column;
      background: #fff;
      overflow-y: auto;
      align-items: flex-start;
      justify-content: flex-start;
      padding: 0 0.5rem 0 0.5rem;
    }
    #messages {
      width: 100%;
      max-width: 100%;
      height: 100%;
      min-height: 100%;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin: 0;
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
    }
    /* ç¾åŒ–æ»šåŠ¨æ¡ */
    .chat-messages-area::-webkit-scrollbar, #messages::-webkit-scrollbar {
      width: 8px;
      background: #f3f4f6;
      border-radius: 8px;
    }
    .chat-messages-area::-webkit-scrollbar-thumb, #messages::-webkit-scrollbar-thumb {
      background: #b3bcf5;
      border-radius: 8px;
    }
    /* è®©message-itemå®½åº¦è‡ªé€‚åº” */
    .message-item {
      width: 95%;
      margin-left: auto;
      margin-right: auto;
    }
    /* ä¿®æ”¹ç•™è¨€ç•Œé¢ä¸ºå…¨å±é¡µé¢é£æ ¼ï¼ŒåŒºåŸŸæ›´å¤§ï¼Œå†…å®¹å±…ä¸­ï¼Œå®½åº¦æ”¾å®½ */
    #chat-section.page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.98);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    #chat-section.page-section > .chat-flex {
      max-width: 1400px;
      width: 96vw;
      height: 80vh;
      min-height: 500px;
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.10);
      background: rgba(255,255,255,0.98);
      margin: 0 auto;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      justify-content: center;
      padding: 0;
    }
    /* ä¸åº”ç”¨.page-section > divçš„é€šç”¨å†…å®¹åŒºæ ·å¼åˆ°.chat-flex */
    #chat-section.page-section > div:not(.chat-flex) {
      background: none;
      box-shadow: none;
      padding: 0;
      min-height: 0;
    }
    .container-card-charts {
      position: relative;
      width: 300px;
      height: 300px;
      background: linear-gradient(
        to top,
        rgba(255, 255, 255),
        rgba(255, 255, 255, 0.1)
      );
      border-radius: 32px;
      padding: 1.6px;
      box-shadow: 0 0px 80px -10px rgba(255, 255, 255, 0.15);
    }
    .container-card-charts::before {
      position: absolute;
      content: "";
      bottom: -40px;
      left: 50%;
      transform: translateX(-50%);
      width: 80px;
      height: 80px;
      background-color: #777777;
      z-index: -10;
      filter: blur(70px);
    }
    .card-charts {
      width: 100%;
      height: 100%;
      background: radial-gradient(ellipse at center, #1b1b1b, #000000);
      border-radius: 32px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .charts-lines {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .charts-lines i {
      position: absolute;
      inset: 0;
      display: flex;
      width: 100%;
      height: 100%;
    }
    .lines {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: space-between;
    }
    .lines span {
      width: 1.5px;
      height: 100%;
      margin: 0 18px;
      background: linear-gradient(
        to top,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.025) 50%,
        rgba(255, 255, 255, 0) 100%
      );
    }
    .tags-card {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
    }
    .tags-card .radio {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      border-radius: 12px;
      color: #a7a7a7;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    .tags-card .radio:hover {
      color: #ffffff;
    }
    .tags-card .radio input {
      display: none;
    }
    .tags-card .radio .name {
      width: 100%;
      padding: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      z-index: 1;
    }
    .tags-card .radio input:checked + .name {
      color: #ffffff;
      background: linear-gradient(15deg, #898989, #181818, #000000);
      transform: scale(1.1);
    }
    .tags-card .radio input:checked + .name::before {
      position: absolute;
      background-color: #212121;
      content: "";
      inset: 1px;
      z-index: -1;
      border-radius: 12px;
    }
    .main-texts {
      display: flex;
      flex-direction: column;
      padding: 0 20px;
      font-weight: 500;
    }
    .main-texts .title {
      background-image: linear-gradient(to top left, #92400e, #f9d86d, #a6a6a6);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
    .main-texts .change {
      background-image: linear-gradient(to right, #8e1414, #ffffff, #ffffff);
      background-clip: text;
      -webkit-background-clip: text;
      color: transparent;
    }
    .charts-lines path {
      opacity: 0;
    }
    .card-charts svg {
      transition: transform 0.5s ease;
    }
    .card-charts:hover svg {
      transform: scale(1.5);
    }
    .icon-week path {
      animation: draw 8s ease infinite;
    }
    .icon-month path {
      animation: draw 8s 3s ease infinite;
    }
    @keyframes draw {
      0% {
        stroke-dashoffset: 1500;
        opacity: 0.8;
      }
      50% {
        stroke-dashoffset: 0;
      }
      100% {
        stroke-dashoffset: -1500;
        opacity: 0.8;
      }
    }
    /* è®©æ‰€æœ‰ .page-section åŒºå—å…¨å±ç‹¬ç«‹ï¼Œå†…å®¹å±…ä¸­ï¼Œå®½åº¦è‡ªé€‚åº” */
    .page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    /* è®©å†…å®¹åŒºå—å®½åº¦é€‚ä¸­ä¸”å±…ä¸­ç¾è§‚ */
    .page-section > div {
      max-width: 1200px;
      width: 90vw;
      margin: 0 auto;
      background: rgba(255,255,255,0.98);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(60,60,120,0.10);
      padding: 40px 32px;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-start;
    }
    /* é’ˆå¯¹ repo-section å†…éƒ¨å¡ç‰‡å®¹å™¨ç‰¹æ®Šå¤„ç†ï¼Œé¿å…é‡å¤åŒ…è£¹ */
    #repo-section > div {
      background: none;
      box-shadow: none;
      padding: 0;
      min-height: 0;
      align-items: center;
      justify-content: center;
    }
    .container {
      width: 56px;
      height: 56px;
      position: fixed;
      left: unset;
      right: 20px;
      bottom: 30px;
      border-radius: 12px; /* æ–¹å½¢åœ†è§’ */
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2100;
    }
    .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: conic-gradient(#ff6347, #ff6347);
      cursor: pointer;
      outline: none;
    }
   
    .play-btn:checked {
      animation: borderAnimate 700ms ease-in-out 1;
      animation-fill-mode: forwards;
    }
    @keyframes borderAnimate {
      0% {
        transform: rotate(0);
        background: conic-gradient(#ff6347, transparent 20%);
      }
      80% {
        background: conic-gradient(#ff6347, transparent 90%);
      }
      100% {
        transform: rotate(360deg);
        background: conic-gradient(#ff6347, #ff6347);
      }
    }
    .play-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 60%;
      top: 50%;
      background-color: #ff6347;
      transform: translate(-60%, -50%) rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      cursor: pointer;
    }
    .play-btn:checked + .play-icon {
      clip-path: polygon(0 100%, 0% 100%, 100% 100%);
    }
    .pause-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .pause-icon::before {
      content: "";
      position: absolute;
      width: 0%;
      height: 100%;
      background-color: #ff6347;
      left: 0;
    }
    .pause-icon::after {
      content: "";
      position: absolute;
      width: 0;
      height: 100%;
      background-color: #ff6347;
      right: 0;
    }
    .play-btn:checked ~ .pause-icon::before {
      animation: reveal 300ms ease-in-out 350ms 1;
      animation-fill-mode: forwards;
    }
    .play-btn:checked ~ .pause-icon::after {
      animation: reveal 300ms ease-in-out 600ms 1;
      animation-fill-mode: forwards;
    }
    @keyframes reveal {
      0% {
        width: 0;
      }
      100% {
        width: 35%;
      }
    }
    #music-visualizer-btn {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 100px;
      height: 100px;
      pointer-events: none;
      z-index: 1;
    }
    .music-btn-core {
      width: 60px;
      height: 60px;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: #000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      border: 2px solid #ff6347;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      cursor: pointer;
      outline: none;
      z-index: 3;
      opacity: 0;
    }
    .play-icon {
      width: 20px;
      height: 20px;
      background-color: #ff6347;
      transform: rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      z-index: 1;
    }
    .pause-icon {
      width: 18px;
      height: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1;
      opacity: 0;
      pointer-events: none;
    }
    .pause-icon::before,
    .pause-icon::after {
      content: "";
      display: block;
      width: 6px;
      height: 100%;
      background-color: #ff6347;
      border-radius: 1px;
    }
    .play-btn:checked + .play-icon {
      opacity: 0;
      pointer-events: none;
    }
    .play-btn:checked ~ .pause-icon {
      opacity: 1;
      pointer-events: auto;
    }

    /* æ–¹å½¢æ’­æ”¾æŒ‰é’®æ ·å¼ï¼Œé€‚é…å¯¼èˆªæ  */
    .navbar-play-btn {
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 2px 12px rgba(0,0,0,0.10);
      margin-left: 12px;
      position: relative;
    }
    .navbar-play-btn .play-btn {
      position: absolute;
      appearance: none;
      width: 100%;
      height: 100%;
      border-radius: 12px;
      background: conic-gradient(#ff6347, #ff6347);
      cursor: pointer;
      outline: none;
    }
    .navbar-play-btn .play-btn::before {
      content: "";
      position: absolute;
      width: 93%;
      height: 93%;
      background-color: #000;
      border-radius: 8px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .navbar-play-btn .play-btn:checked {
      animation: borderAnimate 700ms ease-in-out 1;
      animation-fill-mode: forwards;
    }
    @keyframes borderAnimate {
      0% {
        transform: rotate(0);
        background: conic-gradient(#ff6347, transparent 20%);
      }
      80% {
        background: conic-gradient(#ff6347, transparent 90%);
      }
      100% {
        transform: rotate(360deg);
        background: conic-gradient(#ff6347, #ff6347);
      }
    }
    .navbar-play-btn .play-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 60%;
      top: 50%;
      background-color: #ff6347;
      transform: translate(-60%, -50%) rotate(90deg);
      clip-path: polygon(50% 15%, 0% 100%, 100% 100%);
      transition: all 400ms ease-in-out;
      cursor: pointer;
    }
    .navbar-play-btn .play-btn:checked + .play-icon {
      clip-path: polygon(0 100%, 0% 100%, 100% 100%);
    }
    .navbar-play-btn .pause-icon {
      position: absolute;
      width: 28px;
      height: 28px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .navbar-play-btn .pause-icon::before {
      content: "";
      position: absolute;
      width: 0%;
      height: 100%;
      background-color: #ff6347;
      left: 0;
    }
    .navbar-play-btn .pause-icon::after {
      content: "";
      position: absolute;
      width: 0;
      height: 100%;
      background-color: #ff6347;
      right: 0;
    }
    .navbar-play-btn .play-btn:checked ~ .pause-icon::before {
      animation: reveal 300ms ease-in-out 350ms 1;
      animation-fill-mode: forwards;
    }
    .navbar-play-btn .play-btn:checked ~ .pause-icon::after {
      animation: reveal 300ms ease-in-out 600ms 1;
      animation-fill-mode: forwards;
    }
    @keyframes reveal {
      0% {
        width: 0;
      }
      100% {
        width: 35%;
      }
    }
    /* å¯¼èˆªæ ä¸Šæ–¹é¢‘è°±æ¡æ ·å¼ï¼ˆä¿®æ­£ç‰ˆï¼‰ */
    #navbar-spectrum {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 100px;
      z-index: 1999;
      width: 380px;
      max-width: 85vw;
      height: 50px;
      pointer-events: none;
      display: none;
      background: transparent;
      opacity: 0.8;
    }
    /* æ”¾å¤§ç™»å½•ç•Œé¢æ•´ä½“ã€è¾“å…¥æ¡†ã€æŒ‰é’®å’Œæ–‡å­— */
    #welcome-section.form {
      max-width: 480px !important;
      width: 100% !important;
      padding: 48px 0 !important;
    }
    #welcome-section .avatar {
      width: 120px;
      height: 120px;
      margin-bottom: 2rem !important;
    }
    #welcome-section p {
      font-size: 2.2rem !important;
      margin-bottom: 1.2rem !important;
    }
    #welcome-section p > span {
      font-size: 1.3rem !important;
    }
    #welcome-section .intro {
      font-size: 1.25rem !important;
      margin-bottom: 1.5rem !important;
    }
    #welcome-section input[type="text"] {
      width: 340px !important;
      height: 54px !important;
      font-size: 1.2rem !important;
      padding: 10px 18px !important;
      border-radius: 12px !important;
    }
    #welcome-section .oauthButton {
      width: 340px !important;
      height: 54px !important;
      font-size: 1.25rem !important;
      border-radius: 12px !important;
      margin-top: 1.2rem !important;
    }
    #archive-section.page-section {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(120deg, #a5b4fc 0%, #b39ddb 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
      padding: 0;
      box-sizing: border-box;
      border-radius: 0;
      box-shadow: none;
      overflow: auto;
    }
    #archive-section .center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
    }
    #archive-section .center-content > div {
      max-width: 1000px !important;
      width: 100vw !important;
      min-height: 500px !important;
    }
    #archive-section.page-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding-top: 60px;
      padding-bottom: 60px;
    }
    #archive-section .center-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 90vw;
      max-width: 1400px;
    }
    #archive-section .charts-container {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 40px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      width: 100%;
      box-sizing: border-box;
    }
    #archive-section .charts-container > div {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
    }
    #archive-section .charts-container > div > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      padding: 10px;
      box-sizing: border-box;
    }
    #archive-section .charts-container svg {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }
    /* GitHubæŒ‰é’®æ ·å¼ */
    .btn-github {
      text-decoration: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border: none;
      transition: all 0.5s cubic-bezier(0.165, 0.84, 0.44, 1);
      border-radius: 100px;
      font-weight: 800;
      padding: 0.75rem 1rem;
      font-size: 0.825rem;
      line-height: 1rem;
      background-color: rgba(0, 0, 0, 0.4);
      box-shadow:
        inset 0 1px 0 0 rgba(255, 255, 255, 0.04),
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      color: #fff !important;
    }
    .btn-github:hover {
      box-shadow:
        inset 0 1px 0 0 rgba(255, 255, 255, 0.08),
        inset 0 0 0 1px rgba(252, 232, 3, 0.08);
      color: #fce803 !important;
      transform: translate(0, -0.25rem);
      background-color: rgba(0, 0, 0, 0.5);
    }
    .btn-github svg {
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div class="center-bg">
    <form action="javascript:void(0);" class="form" id="welcome-section">
      <img src="https://api.dicebear.com/7.x/miniavs/svg?seed=ç‹å®¶ç¿" class="avatar" alt="å¤´åƒ" style="margin-bottom: 1rem;" />
      <p style="margin-bottom:0;">
        ç‹å®¶ç¿çš„ä¸ªäººç®€å†
        <span>æ¬¢è¿æ¥åˆ°æˆ‘çš„ä¸“å±ç©ºé—´</span>
      </p>
      <div class="intro" style="text-align:center; color:#374151; font-size:15px; margin-bottom:0;">
        é‡åº†ç†å·¥å¤§å­¦ Â· ç”µå­ä¿¡æ¯å·¥ç¨‹ Â· çƒ­çˆ±ç¼–ç¨‹ä¸åˆ›æ–°
      </div>
      <input type="text" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" id="nickname" name="nickname">
      <button class="oauthButton" type="button" onclick="startChat()">
        è¿›å…¥ç•™è¨€ä¸æŸ¥çœ‹ç®€å†
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 17 5-5-5-5"></path><path d="m13 17 5-5-5-5"></path></svg>
      </button>
    </form>
    <div id="leave-section" style="display:none;"></div>
    </div>
  
    <!-- ä¸ªäººç®€ä»‹ -->
  <div id="profile-section" style="display:none;">
    <div id="personal-info-wrapper">
      <h2>å…³äºæˆ‘ - ç‹å®¶ç¿</h2>
      <p><strong>å­¦æ ¡ï¼š</strong> é‡åº†ç†å·¥å¤§å­¦</p>
      <p><strong>å­¦é™¢ï¼š</strong> ç”µæ°”ä¸ç”µå­å·¥ç¨‹å­¦é™¢</p>
      <p><strong>ä¸“ä¸šï¼š</strong> ç”µå­ä¿¡æ¯å·¥ç¨‹</p>
      <p><strong>ç»©ç‚¹ï¼š</strong> 3.2 / 5.0</p>
      <hr>
    </div>
    <div id="tree-of-life-embed" style="display:none; margin-top:0;">
      <iframe src="final.htm" style="width:100vw;height:100vh;border:none;display:block;background:#fff;" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
  <div id="chat-section" class="page-section" style="display:none;">
    <div class="chat-flex">
      <div class="chat-input-area">
      <h2>ğŸ’¬ æ¬¢è¿ <span id="welcome-name"></span>ï¼è¯·ç•™è¨€ï¼š</h2>
      <label class="input-label" for="message-input">ä½ çš„ç•™è¨€ï¼š</label>
      <input class="input" placeholder="å†™ç‚¹ä»€ä¹ˆ..." type="text" id="message-input" />
      <button class="btn" onclick="submitMessage()">æäº¤ç•™è¨€</button>
      <div id="loading-animation" class="loader">
          <span class="l">L</span><span class="o">O</span><span class="a">A</span><span class="d">D</span><span class="ispan">I</span><span class="n">N</span><span class="g">G</span>
      </div>
      </div>
      <div class="chat-messages-area">
        <div class="mt-6" id="messages"></div>
      </div>
    </div>
  </div>
  <!-- å¯¼èˆªæ¡æ”¾åœ¨bodyæœ€å¤–å±‚ -->
  <div class="menu" id="bottom-menu" style="display:none;">
    <a href="#" class="link active" id="nav-home" data-target="profile-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 256 256">
          <rect width="256" height="256" fill="none"></rect>
          <path d="M213.3815,109.61945,133.376,36.88436a8,8,0,0,0-10.76339.00036l-79.9945,72.73477A8,8,0,0,0,40,115.53855V208a8,8,0,0,0,8,8H208a8,8,0,0,0,8-8V115.53887A8,8,0,0,0,213.3815,109.61945Z" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="16"></path>
        </svg>
      </span>
      <span class="link-title">é¦–é¡µ</span>
    </a>
    <a href="#" class="link" id="nav-repo" data-target="repo-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M20.54 5.23l-1.39-1.39C18.93 3.53 18.48 3.5 18.07 3.5H5.93c-.41 0-.86.03-1.08.34l-1.39 1.39C3.21 5.42 3 5.7 3 6v2c0 .55.45 1 1 1h1v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V9h1c.55 0 1-.45 1-1V6c0-.3-.21-.58-.46-.77zM19 8H5V6.12l.93-.92h12.14l.93.92V8zm-2 10H7V9h10v9z"/></svg>
      </span>
      <span class="link-title">ä»“åº“</span>
    </a>
    <a href="#" class="link" id="nav-archive" data-target="archive-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
      </span>
      <span class="link-title">æˆå°±</span>
    </a>
    <a href="#" class="link" id="nav-chat" data-target="chat-section">
      <span class="link-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M21 6h-2v9H5V6H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 14H3v-2h18v2zm0-4H3v-2h18v2zm0-4H3v-2h18v2z"/></svg>
      </span>
      <span class="link-title">ç•™è¨€</span>
    </a>
    <div class="navbar-play-btn" id="navbar-play-btn">
      <input type="checkbox" class="play-btn" id="music-toggle">
      <span class="play-icon"></span>
      <span class="pause-icon"></span>
      <audio id="navbar-audio" src="mytreasureçº¯éŸ³ä¹.mp4" preload="auto"></audio>
      </div>
    </div>
  
  <!-- åœ¨å¯¼èˆªæ¡æ—è¾¹æ’å…¥æŒ‰é’® -->


  <!-- åœ¨å¯¼èˆªæ .menuä¸Šæ–¹æ’å…¥é¢‘è°±canvas -->
  <canvas id="navbar-spectrum"></canvas>
  </body>
  </html>

<script>
  // å…¨å±€éŸ³é¢‘å˜é‡
  window.hasAutoPlayedOnce = window.hasAutoPlayedOnce || false;
  window.isUserPaused = window.isUserPaused || false;
  window.oncePlayOnBodyHandler = window.oncePlayOnBodyHandler || null;
  window.spectrumAnimationId = window.spectrumAnimationId || null;
  window.audioContext = window.audioContext || null;
  window.analyser = window.analyser || null;
  window.dataArray = window.dataArray || null;

  // å…¨å±€éŸ³é¢‘åˆ†æå™¨åˆå§‹åŒ–å‡½æ•°
  window.initAudioAnalyserGlobal = function(audioPlayer) {
    if (!window.audioContext || window.audioContext.state === 'closed') {
      console.log("åˆ›å»ºæ–°çš„AudioContext");
      window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const source = window.audioContext.createMediaElementSource(audioPlayer);
      window.analyser = window.audioContext.createAnalyser();
      window.analyser.fftSize = 256;
      source.connect(window.analyser);
      window.analyser.connect(window.audioContext.destination);
      window.dataArray = new Uint8Array(window.analyser.frequencyBinCount);
      console.log("å…¨å±€AudioContextå’ŒAnalyserå·²åˆå§‹åŒ–/é‡æ–°åˆå§‹åŒ–");
    } else if (window.audioContext.state === 'suspended') {
      window.audioContext.resume().then(() => {
        console.log("AudioContextåœ¨initAudioAnalyserGlobalä¸­å·²æ¢å¤");
      }).catch(e => console.error("AudioContextæ¢å¤å¤±è´¥:", e));
    }
  };

  // å…¨å±€é¢‘è°±ç»˜åˆ¶å‡½æ•°
  window.drawSpectrumGlobal = function(navbarSpectrum) {
    if (!window.analyser || !window.audioContext) {
      console.warn("drawSpectrumGlobal: Analyseræˆ–AudioContextæœªå°±ç»ª");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      if(navbarSpectrum) navbarSpectrum.style.display = 'none';
      return;
    }

    const audioPlayerElement = document.getElementById('navbar-audio');

    if (window.audioContext.state === 'suspended') {
      window.audioContext.resume().then(() => {
        console.log("AudioContextåœ¨drawSpectrumGlobalä¸­å·²æ¢å¤ã€‚è¯·æ±‚åŠ¨ç”»å¸§");
        if (audioPlayerElement && !audioPlayerElement.paused && !window.isUserPaused) {
          navbarSpectrum.style.display = 'block';
        } else {
          navbarSpectrum.style.display = 'none';
        }
        if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
        window.spectrumAnimationId = requestAnimationFrame(() => window.drawSpectrumGlobal(navbarSpectrum));
      }).catch(e => {
        console.error("AudioContextåœ¨drawSpectrumGlobalä¸­æ¢å¤å¤±è´¥:", e);
        if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
        window.spectrumAnimationId = null;
        navbarSpectrum.style.display = 'none';
      });
      return;
    }

    if (window.audioContext.state === 'closed') {
      console.warn("AudioContextå·²å…³é—­ã€‚æ— æ³•ç»˜åˆ¶é¢‘è°±");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      navbarSpectrum.style.display = 'none';
      return;
    }

    if (audioPlayerElement && (audioPlayerElement.paused || window.isUserPaused)) {
      console.log("éŸ³é¢‘å·²æš‚åœæˆ–ç”¨æˆ·æš‚åœï¼Œåœæ­¢é¢‘è°±");
      if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
      window.spectrumAnimationId = null;
      navbarSpectrum.style.display = 'none';
      const ctx = navbarSpectrum.getContext('2d');
      if (ctx) ctx.clearRect(0, 0, navbarSpectrum.width, navbarSpectrum.height);
      return;
    }

    if (window.spectrumAnimationId) cancelAnimationFrame(window.spectrumAnimationId);
    window.spectrumAnimationId = requestAnimationFrame(() => window.drawSpectrumGlobal(navbarSpectrum));

    window.analyser.getByteFrequencyData(window.dataArray);

    const canvas = navbarSpectrum;
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    const barWidth = (width / window.dataArray.length) * 2.5;
    let x = 0;

    for (let i = 0; i < window.dataArray.length; i++) {
      const barHeight = (window.dataArray[i] / 255) * height;
      const gradient = ctx.createLinearGradient(0, height, 0, 0);
      gradient.addColorStop(0, '#4f46e5');
      gradient.addColorStop(0.5, '#6366f1');
      gradient.addColorStop(1, '#a5b4fc');
      ctx.fillStyle = gradient;
      ctx.fillRect(x, height - barHeight, barWidth, barHeight);
      x += barWidth + 1;
    }
  };

  document.addEventListener('DOMContentLoaded', function() {
    const musicToggleElement = document.getElementById('music-toggle');
    const audioPlayerElement = document.getElementById('navbar-audio');
    const navbarSpectrumElement = document.getElementById('navbar-spectrum');

    if (musicToggleElement && audioPlayerElement && navbarSpectrumElement) {
      navbarSpectrumElement.width = 380;
      navbarSpectrumElement.height = 50;

      musicToggleElement.checked = !audioPlayerElement.paused && window.hasAutoPlayedOnce && !window.isUserPaused;
      navbarSpectrumElement.style.display = musicToggleElement.checked ? 'block' : 'none';

      musicToggleElement.addEventListener('change', function() {
        if (this.checked) {
          window.isUserPaused = false;
          const playLogic = () => {
            audioPlayerElement.play().then(() => {
              console.log("é€šè¿‡å¼€å…³å¯åŠ¨æ’­æ”¾");
              if (window.oncePlayOnBodyHandler) {
                document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
                window.oncePlayOnBodyHandler = null;
              }
            }).catch(error => {
              console.error("å¼€å…³æ’­æ”¾å¤±è´¥:", error);
              this.checked = false;
              window.isUserPaused = true;
              navbarSpectrumElement.style.display = 'none';
            });
          };

          if (window.audioContext && window.audioContext.state === 'suspended') {
            window.audioContext.resume().then(playLogic).catch(e => {
              console.error("æ’­æ”¾å‰æ¢å¤ä¸Šä¸‹æ–‡å¤±è´¥:", e);
              this.checked = false;
              window.isUserPaused = true;
              navbarSpectrumElement.style.display = 'none';
            });
          } else {
            playLogic();
          }
        } else {
          window.isUserPaused = true;
          audioPlayerElement.pause();
        }
      });

      audioPlayerElement.addEventListener('play', function() {
        console.log("'play'äº‹ä»¶ã€‚isUserPaused:", window.isUserPaused);
        if (!window.isUserPaused) {
          musicToggleElement.checked = true;
          navbarSpectrumElement.style.display = 'block';
          window.initAudioAnalyserGlobal(audioPlayerElement);
          window.drawSpectrumGlobal(navbarSpectrumElement);
        } else {
          audioPlayerElement.pause();
          musicToggleElement.checked = false;
          navbarSpectrumElement.style.display = 'none';
        }
        if (window.oncePlayOnBodyHandler) {
          document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
          window.oncePlayOnBodyHandler = null;
        }
      });

      audioPlayerElement.addEventListener('pause', function() {
        console.log("'pause'äº‹ä»¶ã€‚isUserPaused:", window.isUserPaused);
        if (window.isUserPaused || audioPlayerElement.paused) {
          musicToggleElement.checked = false;
        }
        navbarSpectrumElement.style.display = 'none';
        if (window.spectrumAnimationId) {
          cancelAnimationFrame(window.spectrumAnimationId);
          window.spectrumAnimationId = null;
        }
        const spectrumCtx = navbarSpectrumElement.getContext('2d');
        if (spectrumCtx) spectrumCtx.clearRect(0, 0, navbarSpectrumElement.width, navbarSpectrumElement.height);

        if (window.audioContext && window.audioContext.state === 'running' && window.isUserPaused) {
          window.audioContext.suspend().catch(e => console.error("æš‚åœæ—¶æŒ‚èµ·å¤±è´¥", e));
        }
      });

      audioPlayerElement.addEventListener('ended', function() {
        console.log("'ended'äº‹ä»¶ã€‚isUserPaused:", window.isUserPaused);
        audioPlayerElement.currentTime = 0;
        if (!window.isUserPaused) {
          const playPromise = audioPlayerElement.play();
          if (playPromise !== undefined) {
            playPromise.catch(e => {
              console.log("ç»“æŸåå¾ªç¯æ’­æ”¾å°è¯•å¤±è´¥:", e);
              if (!window.isUserPaused && !window.oncePlayOnBodyHandler) {
                window.oncePlayOnBodyHandler = () => {
                  window.isUserPaused = false;
                  audioPlayerElement.play().catch(() => {});
                  document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
                  window.oncePlayOnBodyHandler = null;
                };
                document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
              }
            });
          }
        } else {
          musicToggleElement.checked = false;
          navbarSpectrumElement.style.display = 'none';
        }
      });
    }

    setTimeout(() => {
      if (audioPlayerElement && !window.hasAutoPlayedOnce && audioPlayerElement.paused && !window.isUserPaused) {
        console.log("åˆå§‹è‡ªåŠ¨æ’­æ”¾å›é€€ï¼šæ·»åŠ bodyç‚¹å‡»ç›‘å¬å™¨");
        if (!window.oncePlayOnBodyHandler) {
          window.oncePlayOnBodyHandler = () => {
            console.log("åˆå§‹æ’­æ”¾çš„bodyç‚¹å‡»å¤„ç†ç¨‹åºè§¦å‘");
            window.isUserPaused = false;
            audioPlayerElement.play().then(() => {
              window.hasAutoPlayedOnce = true;
            }).catch((err) => {
              console.error("bodyç‚¹å‡»åˆå§‹æ’­æ”¾å¤±è´¥:", err);
            });
            document.body.removeEventListener('click', window.oncePlayOnBodyHandler);
            window.oncePlayOnBodyHandler = null;
          };
          document.body.addEventListener('click', window.oncePlayOnBodyHandler, { once: true });
        }
      }
    }, 500);

    // å…¶ä»–DOMContentLoadedé€»è¾‘
    var showBtn = document.getElementById('show-leave-btn');
    var leaveSection = document.getElementById('leave-section');
    if(showBtn && leaveSection) {
      showBtn.addEventListener('click', function() {
        showBtn.style.display = 'none';
        leaveSection.style.display = 'block';
      });
    }

    // å¯¼èˆªç›¸å…³å‡½æ•°
    const navChatButton = document.getElementById('nav-chat');
    if (navChatButton) {
      navChatButton.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        document.getElementById('chat-section').style.display = 'block';
        const leaveSectionDiv = document.getElementById('leave-section');
        if (leaveSectionDiv) {
          leaveSectionDiv.style.display = 'none';
        }
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    }

    const navRepoButton = document.getElementById('nav-repo');
    if (navRepoButton) {
      navRepoButton.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        const repoSection = document.getElementById('repo-section');
        if (repoSection) repoSection.style.display = 'block';
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
      });
    }

    // ä¸»å¯¼èˆªé€»è¾‘
    document.querySelectorAll('.menu .link').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
        this.classList.add('active');
        
        const targetId = this.getAttribute('data-target');
        document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
        
        const targetSection = document.getElementById(targetId);
        if (targetSection) {
          targetSection.style.display = 'block';
          if (targetId === 'archive-section') {
            setTimeout(() => {
              if (typeof initGradesChart === 'function') initGradesChart();
              if (typeof initCoursesChart === 'function') initCoursesChart();
            }, 100);
          }
        } else {
          console.warn("æœªæ‰¾åˆ°ç›®æ ‡éƒ¨åˆ†:", targetId);
        }
        
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');

        if (targetId === 'profile-section') {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
          if (treeEmbed) treeEmbed.style.display = 'block';
        } else if (targetId === 'chat-section') {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
          if (treeEmbed) treeEmbed.style.display = 'none';
        } else {
          if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
          if (treeEmbed) treeEmbed.style.display = 'none';
        }
        
        document.getElementById("bottom-menu").style.display = "flex";
      });
    });

    // çŸ©é˜µé›¨å’Œåœ°å›¾å¡ç‰‡é€»è¾‘
    const matrixRainCard = document.getElementById('matrix-rain-card');
    const chongqingMapCard = document.getElementById('chongqing-map-card');
    const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
    const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
    const closeMatrixRain = document.getElementById('close-matrix-rain');
    const closeChongqingMap = document.getElementById('close-chongqing-map');

    let matrixRainCanvas, matrixRainCtx, matrixRainInterval;
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
    const drops = [];

    function initMatrixRain() {
      matrixRainCanvas = document.getElementById('matrix-rain-canvas');
      if (!matrixRainCanvas) return;
      
      matrixRainCtx = matrixRainCanvas.getContext('2d');
      matrixRainCanvas.width = window.innerWidth;
      matrixRainCanvas.height = window.innerHeight;
      
      const columns = Math.floor(matrixRainCanvas.width / 20);
      drops.length = 0;
      for (let i = 0; i < columns; i++) {
        drops[i] = 1 + Math.random() * matrixRainCanvas.height / 20;
      }
      
      if (matrixRainInterval) clearInterval(matrixRainInterval);
      matrixRainInterval = setInterval(drawMatrixRain, 33);
    }

    function drawMatrixRain() {
      if (!matrixRainCtx || !matrixRainCanvas) return;
      matrixRainCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
      matrixRainCtx.fillRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
      
      matrixRainCtx.fillStyle = '#0F0';
      matrixRainCtx.font = '15px monospace';
      
      for (let i = 0; i < drops.length; i++) {
        const text = chars[Math.floor(Math.random() * chars.length)];
        matrixRainCtx.fillText(text, i * 20, drops[i] * 20);
        
        if (drops[i] * 20 > matrixRainCanvas.height && Math.random() > 0.975) {
          drops[i] = 0;
        }
        drops[i]++;
      }
    }

    function stopMatrixRain() {
      if (matrixRainInterval) {
        clearInterval(matrixRainInterval);
        matrixRainInterval = null;
      }
      if (matrixRainCtx && matrixRainCanvas) {
        matrixRainCtx.clearRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
      }
    }
    
    if (matrixRainCard && matrixRainFullscreen) {
      matrixRainCard.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'flex';
        initMatrixRain();
      });
    }

    if (closeMatrixRain) {
      closeMatrixRain.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'none';
        stopMatrixRain();
      });
    }

    if (chongqingMapCard && chongqingMapFullscreen) {
      chongqingMapCard.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'flex';
      });
    }

    if (closeChongqingMap) {
      closeChongqingMap.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'none';
      });
    }

    window.addEventListener('resize', function() {
      if (matrixRainCanvas && matrixRainFullscreen.style.display === 'flex') {
        matrixRainCanvas.width = window.innerWidth;
        matrixRainCanvas.height = window.innerHeight;
        const columns = Math.floor(matrixRainCanvas.width / 20);
        if (drops.length !== columns) {
          drops.length = 0;
          for (let i = 0; i < columns; i++) {
            drops[i] = 1 + Math.random() * matrixRainCanvas.height / 20;
          }
        }
      }
      const archiveSection = document.getElementById('archive-section');
      if (archiveSection && archiveSection.style.display !== 'none') {
        if (typeof initGradesChart === 'function') initGradesChart();
        if (typeof initCoursesChart === 'function') initCoursesChart();
      }
    });
  });

  // --- ä½ å·²æœ‰çš„å…¶ä»– DOMContentLoaded é€»è¾‘ï¼Œå¦‚å¯¼èˆªç­‰ ---
  var showBtn = document.getElementById('show-leave-btn');
  var leaveSection = document.getElementById('leave-section');
  if(showBtn && leaveSection) {
    showBtn.addEventListener('click', function() {
      showBtn.style.display = 'none';
      leaveSection.style.display = 'block';
    });
  }

  // --- ä½ å·²æœ‰çš„å…¨å±€å‡½æ•° ---
  function showGames(){}
  function showSearch(){}
  function showProfile(){
    document.getElementById("profile-section").style.display = "block";
    document.getElementById("chat-section").style.display = "none";
    document.getElementById("leave-section").style.display = "none";
    document.querySelector('.menu').style.display = 'flex';
    
    // ç¡®ä¿ä¸ªäººä¿¡æ¯å’Œæ ‘çš„çŠ¶æ€æ­£ç¡®
    const personalInfoWrapper = document.getElementById('personal-info-wrapper');
    const treeEmbed = document.getElementById('tree-of-life-embed');
    if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
    if (treeEmbed) treeEmbed.style.display = 'block';
  }

  function showChat() {
    document.getElementById("chat-section").style.display = "block";
    document.getElementById("leave-section").style.display = "block";
    document.getElementById("profile-section").style.display = "none";
    
    // ç¡®ä¿ä¸ªäººä¿¡æ¯å’Œæ ‘çš„çŠ¶æ€æ­£ç¡®
    const personalInfoWrapper = document.getElementById('personal-info-wrapper');
    const treeEmbed = document.getElementById('tree-of-life-embed');
    if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
    if (treeEmbed) treeEmbed.style.display = 'none';
  }

  const navChatButton = document.getElementById('nav-chat');
  if (navChatButton) {
    navChatButton.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      document.getElementById('chat-section').style.display = 'block';
      const leaveSectionDiv = document.getElementById('leave-section');
      if (leaveSectionDiv) {
        leaveSectionDiv.style.display = 'none';
      }
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
    });
  }

  const navRepoButton = document.getElementById('nav-repo');
  if (navRepoButton) {
    navRepoButton.addEventListener('click', function(e) {
      e.preventDefault();
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      const repoSection = document.getElementById('repo-section');
      if (repoSection) repoSection.style.display = 'block';
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
    });
  }

  // å¯¼èˆªæ ç‚¹å‡»äº‹ä»¶
  document.querySelectorAll('.menu .link').forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      // åˆ‡æ¢é«˜äº®
      document.querySelectorAll('.menu .link').forEach(l => l.classList.remove('active'));
      this.classList.add('active');
      
      // åˆ‡æ¢å†…å®¹åŒº
      const target = this.getAttribute('data-target');
      document.querySelectorAll('.page-section').forEach(sec => sec.style.display = 'none');
      
      if(target === 'chat-section') {
        document.getElementById('chat-section').style.display = 'block';
        // ç¡®ä¿ä¸ªäººä¿¡æ¯å’Œæ ‘çš„çŠ¶æ€æ­£ç¡®
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
        if (treeEmbed) treeEmbed.style.display = 'none';
      } else if(target === 'profile-section') {
        document.getElementById('profile-section').style.display = 'block';
        // ç¡®ä¿ä¸ªäººä¿¡æ¯å’Œæ ‘çš„çŠ¶æ€æ­£ç¡®
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'none';
        if (treeEmbed) treeEmbed.style.display = 'block';
      } else {
        document.getElementById(target).style.display = 'block';
        // ç¡®ä¿ä¸ªäººä¿¡æ¯å’Œæ ‘çš„çŠ¶æ€æ­£ç¡®
        const personalInfoWrapper = document.getElementById('personal-info-wrapper');
        const treeEmbed = document.getElementById('tree-of-life-embed');
        if (personalInfoWrapper) personalInfoWrapper.style.display = 'block';
        if (treeEmbed) treeEmbed.style.display = 'none';
      }
      
      // æ˜¾ç¤ºåº•éƒ¨èœå•
      document.getElementById("bottom-menu").style.display = "flex";
    });
  });

  const audio = document.getElementById('navbar-audio');
  if (audio) {
    audio.play().then(() => {
      if (musicToggle) musicToggle.checked = true;
      if (navbarSpectrumCanvas) navbarSpectrumCanvas.style.display = 'block';
      if (typeof setupAudioVisualizer === 'function') setupAudioVisualizer();
    }).catch(() => {
      document.body.addEventListener('click', function oncePlay() {
        audio.play();
        if (musicToggle) musicToggle.checked = true;
        if (navbarSpectrumCanvas) navbarSpectrumCanvas.style.display = 'block';
        if (typeof setupAudioVisualizer === 'function') setupAudioVisualizer();
        document.body.removeEventListener('click', oncePlay);
      });
    });
  }

  // æ·»åŠ ä»“åº“å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
  const matrixRainCard = document.getElementById('matrix-rain-card');
  const chongqingMapCard = document.getElementById('chongqing-map-card');
  const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
  const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
  const closeMatrixRain = document.getElementById('close-matrix-rain');
  const closeChongqingMap = document.getElementById('close-chongqing-map');

  if (matrixRainCard && matrixRainFullscreen) {
    matrixRainCard.addEventListener('click', function() {
      matrixRainFullscreen.style.display = 'flex';
      initMatrixRain();
    });
  }

  if (closeMatrixRain) {
    closeMatrixRain.addEventListener('click', function() {
      matrixRainFullscreen.style.display = 'none';
      stopMatrixRain();
    });
  }

  if (chongqingMapCard && chongqingMapFullscreen) {
    chongqingMapCard.addEventListener('click', function() {
      chongqingMapFullscreen.style.display = 'flex';
    });
  }

  if (closeChongqingMap) {
    closeChongqingMap.addEventListener('click', function() {
      chongqingMapFullscreen.style.display = 'none';
    });
  }

  // çŸ©é˜µé›¨åŠ¨ç”»ç›¸å…³å˜é‡å’Œå‡½æ•°
  let matrixRainCanvas, matrixRainCtx, matrixRainInterval;
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%^&*()";
  const drops = [];

  function initMatrixRain() {
    matrixRainCanvas = document.getElementById('matrix-rain-canvas');
    if (!matrixRainCanvas) return;
    
    matrixRainCtx = matrixRainCanvas.getContext('2d');
    matrixRainCanvas.width = window.innerWidth;
    matrixRainCanvas.height = window.innerHeight;
    
    const columns = Math.floor(matrixRainCanvas.width / 20);
    for (let i = 0; i < columns; i++) {
      drops[i] = 1;
    }
    
    if (matrixRainInterval) clearInterval(matrixRainInterval);
    matrixRainInterval = setInterval(drawMatrixRain, 33);
  }

  function drawMatrixRain() {
    matrixRainCtx.fillStyle = 'rgba(0, 0, 0, 0.05)';
    matrixRainCtx.fillRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
    
    matrixRainCtx.fillStyle = '#0F0';
    matrixRainCtx.font = '15px monospace';
    
    for (let i = 0; i < drops.length; i++) {
      const text = chars[Math.floor(Math.random() * chars.length)];
      matrixRainCtx.fillText(text, i * 20, drops[i] * 20);
      
      if (drops[i] * 20 > matrixRainCanvas.height && Math.random() > 0.975) {
        drops[i] = 0;
      }
      drops[i]++;
    }
  }

  function stopMatrixRain() {
    if (matrixRainInterval) {
      clearInterval(matrixRainInterval);
      matrixRainInterval = null;
    }
    if (matrixRainCtx) {
      matrixRainCtx.clearRect(0, 0, matrixRainCanvas.width, matrixRainCanvas.height);
    }
  }

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // æ·»åŠ ä»“åº“å¡ç‰‡çš„ç‚¹å‡»äº‹ä»¶å¤„ç†
    const matrixRainCard = document.getElementById('matrix-rain-card');
    const chongqingMapCard = document.getElementById('chongqing-map-card');
    const matrixRainFullscreen = document.getElementById('matrix-rain-fullscreen');
    const chongqingMapFullscreen = document.getElementById('chongqing-map-fullscreen');
    const closeMatrixRain = document.getElementById('close-matrix-rain');
    const closeChongqingMap = document.getElementById('close-chongqing-map');

    if (matrixRainCard && matrixRainFullscreen) {
      matrixRainCard.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'flex';
        initMatrixRain();
      });
    }

    if (closeMatrixRain) {
      closeMatrixRain.addEventListener('click', function() {
        matrixRainFullscreen.style.display = 'none';
        stopMatrixRain();
      });
    }

    if (chongqingMapCard && chongqingMapFullscreen) {
      chongqingMapCard.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'flex';
      });
    }

    if (closeChongqingMap) {
      closeChongqingMap.addEventListener('click', function() {
        chongqingMapFullscreen.style.display = 'none';
      });
    }

    // ç›‘å¬çª—å£å¤§å°å˜åŒ–
    window.addEventListener('resize', function() {
      if (matrixRainCanvas) {
        matrixRainCanvas.width = window.innerWidth;
        matrixRainCanvas.height = window.innerHeight;
      }
    });
  });

  // å¯¼èˆªç›¸å…³å‡½æ•°
  function showGames() {}
  function showSearch() {}
  
  function showProfile() {
    document.getElementById("profile-section").style.display = "block";
    document.getElementById("chat-section").style.display = "none";
    document.getElementById("leave-section").style.display = "none";
    document.querySelector('.menu').style.display = 'flex';
  }

  function showChat() {
    document.getElementById("chat-section").style.display = "block";
    document.getElementById("leave-section").style.display = "block";
    document.getElementById("profile-section").style.display = "none";
  }

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–
  window.addEventListener('resize', function() {
    if (matrixRainCanvas) {
      matrixRainCanvas.width = window.innerWidth;
      matrixRainCanvas.height = window.innerHeight;
    }
  });

</script>

<!-- æ–°å¢ç¼ºå¤±çš„å†…å®¹åŒº -->
<div id="repo-section" class="page-section" style="display:none;">
  <div style="display:flex;flex-direction:row;flex-wrap:wrap;justify-content:center;align-items:flex-start;gap:32px;padding:40px 15px;width:100%;box-sizing:border-box;height:100%;overflow-y:auto;">
    <!-- çŸ©é˜µé›¨å¡ç‰‡ -->
    <div class="container-card-charts" id="matrix-rain-card" style="cursor:pointer;width:48%;">
      <div class="card-charts" style="position:relative;overflow:hidden;height:100%;">
        <div class="tags-card">
          <span class="name" style="font-size:16px;font-weight:bold;">çŸ©é˜µé›¨</span>
        </div>
        <div class="main-texts">
          <p class="title">Matrix Rain</p>
          <p class="change">ç‚¹å‡»ä½“éªŒå…¨å±åŠ¨ç”»</p>
        </div>
        <canvas id="matrix-rain-thumb" width="260" height="120" style="width:90%;height:120px;display:block;margin:0 auto;border-radius:12px;"></canvas>
      </div>
    </div>
    <!-- é‡åº†åœ°å›¾å¡ç‰‡ -->
    <div class="container-card-charts" id="chongqing-map-card" style="cursor:pointer;width:48%;">
      <div class="card-charts" style="position:relative;overflow:hidden;height:100%;">
        <div class="tags-card">
          <span class="name" style="font-size:16px;font-weight:bold;">é‡åº†åœ°å›¾</span>
        </div>
        <div class="main-texts">
          <p class="title">é‡åº†</p>
          <p class="change">ç‚¹å‡»æŸ¥çœ‹é«˜æ ¡ä½ç½®</p>
        </div>
        <svg width="120" height="120" viewBox="0 0 120 120" style="display:block;margin:0 auto;">
          <path d="M60,10 Q80,20 90,40 Q110,60 80,80 Q60,110 40,90 Q10,80 30,60 Q20,40 40,20 Q50,10 60,10 Z" fill="#e57373" stroke="#b71c1c" stroke-width="2"/>
          <text x="60" y="70" text-anchor="middle" fill="#fff" font-size="22" font-family="monospace">é‡åº†</text>
        </svg>
      </div>
    </div>
  </div>
</div>

<!-- å…¨å±çŸ©é˜µé›¨å¼¹çª— -->
<div id="matrix-rain-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#000;align-items:center;justify-content:center;">
  <canvas id="matrix-rain-canvas" style="width:100vw;height:100vh;display:block;"></canvas>
  <button id="close-matrix-rain" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">å…³é—­</button>
</div>

<!-- å…¨å±é‡åº†åœ°å›¾å¼¹çª—ï¼ˆiframeåµŒå…¥lab4.htmï¼‰ -->
<div id="chongqing-map-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#18181a;align-items:center;justify-content:center;flex-direction:column;">
  <button id="close-chongqing-map" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">å…³é—­</button>
  <iframe src="lab4.htm" width="100%" height="100%" style="border:none;background:#fff;"></iframe>
</div>

<div id="archive-section" class="page-section" style="display:none;">
  <div class="center-content">
    <h2 style="color: #4f46e5; margin-bottom: 30px; text-align: center; width: 100%;">æˆ‘çš„æˆå°±</h2>
    <div class="charts-container" style="background: white; border-radius: 16px; padding: 24px; margin-bottom: 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%;">
      <div style="display: flex; justify-content: space-around; align-items: flex-start; gap: 20px; flex-wrap: wrap;">
        <div style="display: flex; flex-direction: column; align-items: center; min-width: 340px; flex: 1;">
          <h3 style="color: #333; margin-bottom: 20px;">æˆç»©ç­‰çº§åˆ†å¸ƒ</h3>
          <svg id="grades-chart" width="340" height="340" style="display: block; margin: 0 auto; max-width: 100%;"></svg>
        </div>
        <div style="display: flex; flex-direction: column; align-items: center; min-width: 400px; flex: 1;">
          <h3 style="color: #333; margin-bottom: 20px;">è¯¾ç¨‹æˆç»©åˆ†å¸ƒ</h3>
          <svg id="courses-chart" width="400" height="400" style="display: block; margin: 0 auto; max-width: 100%;"></svg>
        </div>
      </div>
    </div>
    <!-- é¡¹ç›®å±•ç¤º -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
      <!-- FPGAé¡¹ç›® -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">FPGAé¡¹ç›®</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">æœ¬äººä¸»è¦èšç„¦äºé¢‘ç»¼è®¾è®¡ã€å°„é¢‘æ§åˆ¶ã€ä¼ æ„Ÿå™¨ç›‘æµ‹ã€è¿œç¨‹æ— çº¿æ“æ§ã€æ¥å£è®¾è®¡ç­‰FPGAåº”ç”¨æ–¹å‘ï¼Œä»£ç ç”±äºæ¶‰å¯†åŸå› ï¼Œæ— æ³•å…¨éƒ¨å…¬å¼€ï¼Œè‹¥éœ€è¦äº†è§£å…·ä½“é¡¹ç›®å†…å®¹ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºç•™ä¸‹è”ç³»æ–¹å¼ã€‚</p>
        </div>
        <a href="https://github.com/Metalphon/Sandalphon/tree/main" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          æŸ¥çœ‹GitHubæºç 
        </a>
      </div>
      <!-- å•ç‰‡æœºé¡¹ç›® -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">å•ç‰‡æœºé¡¹ç›®</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">æœ¬äººä¸»è¦èšç„¦äºä¼ æ„Ÿå™¨ç›‘æµ‹ï¼Œå°„é¢‘æ§åˆ¶ï¼ŒåµŒå…¥å¼é¡¹ç›®è®¾è®¡ç­‰æ–¹å‘ï¼Œä¸»è¦ä½¿ç”¨stm32ï¼Œå¯¹tiå•ç‰‡æœºï¼Œ51å•ç‰‡æœºï¼Œåˆæ³°å•ç‰‡æœºä¹Ÿæœ‰å°‘æ•°é¡¹ç›®ï¼Œä»£ç ç”±äºæ¶‰å¯†åŸå› ï¼Œæ— æ³•å…¨éƒ¨å…¬å¼€ï¼Œè‹¥éœ€è¦äº†è§£å…·ä½“é¡¹ç›®å†…å®¹ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºç•™ä¸‹è”ç³»æ–¹å¼ã€‚</p>
        </div>
        <a href="https://github.com/Metalphon/stm32_project" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          æŸ¥çœ‹GitHubæºç 
        </a>
      </div>
      <!-- Pythoné¡¹ç›® -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">Pythoné¡¹ç›®</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">æœ¬äººä¸»è¦èšç„¦äºä¸²å£æ§åˆ¶ï¼Œç½‘å£æ§åˆ¶ï¼Œä¸Šä½æœºç•Œé¢ç¼–å†™ï¼Œæ‘„åƒå¤´æ§åˆ¶ï¼Œçˆ¬è™«å®è·µç­‰pythonå’Œmicropythonæ–¹å‘ï¼Œä»£ç ç”±äºéƒ¨åˆ†æ¶‰å¯†ï¼Œå¦ä¸€éƒ¨åˆ†ä¾µæƒï¼Œæ— æ³•å…¬å¼€ï¼Œè‹¥éœ€è¦äº†è§£å…·ä½“é¡¹ç›®å†…å®¹ï¼Œå¯ä»¥åœ¨ç•™è¨€åŒºç•™ä¸‹è”ç³»æ–¹å¼ã€‚</p>
        </div>
        <a href="https://github.com/Metalphon/lot" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          æŸ¥çœ‹GitHubæºç 
        </a>
      </div>
      <!-- Webé¡¹ç›® -->
      <div style="background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; min-height: 250px;">
        <div>
          <h3 style="color: #333; margin-bottom: 20px;">Webé¡¹ç›®</h3>
          <p style="color:#444; margin-bottom: 16px; font-size:15px;">åŒ…æ‹¬ä¸ªäººç®€å†ç½‘ç«™ã€æ•°æ®å¯è§†åŒ–å±•ç¤ºç­‰ï¼Œå‰ç«¯åç«¯å‡æœ‰æ¶‰åŠã€‚å¦‚éœ€äº†è§£å…·ä½“é¡¹ç›®å†…å®¹ï¼Œè¯·ç•™è¨€è”ç³»ã€‚</p>
        </div>
        <a href="https://github.com/Metalphon/visual" target="_blank" class="btn-github" style="margin-top:18px; align-self: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:6px;"><path d="M12 2C6.477 2 2 6.484 2 12.021c0 4.428 2.865 8.184 6.839 9.504.5.092.682-.217.682-.482 0-.237-.009-.868-.014-1.703-2.782.605-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.463-1.11-1.463-.908-.62.069-.608.069-.608 1.004.07 1.532 1.032 1.532 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.339-2.221-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.987 1.029-2.686-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.025A9.564 9.564 0 0 1 12 6.844c.85.004 1.705.115 2.504.337 1.909-1.295 2.748-1.025 2.748-1.025.546 1.378.202 2.397.1 2.65.64.699 1.028 1.593 1.028 2.686 0 3.847-2.337 4.695-4.566 4.944.359.309.678.919.678 1.852 0 1.336-.012 2.417-.012 2.747 0 .267.18.577.688.479C19.138 20.2 22 16.447 22 12.021 22 6.484 17.523 2 12 2z"></path></svg>
          æŸ¥çœ‹GitHubæºç 
        </a>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
// æˆç»©é¥¼å›¾
function initGradesChart() {
  const svg = d3.select("#grades-chart");
  svg.selectAll("*").remove();
  const width = 340, height = 340, radius = 140;
  const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
  const color = d3.scaleOrdinal().range(['#4f46e5','#6366f1','#818cf8','#a5b4fc']);
  const data = getGradeLevelData();
  const pie = d3.pie().value(d=>d.value).sort(null);
  const arc = d3.arc().innerRadius(radius*0.6).outerRadius(radius);
  const arcs = g.selectAll("arc").data(pie(data)).enter().append("g");

  // æ·»åŠ ä¸­å¿ƒæç¤ºæ–‡å­—
  const centerText = g.append("text")
    .attr("class","tooltip")
    .style("opacity",0)
    .attr("text-anchor","middle")
    .attr("alignment-baseline","middle")
    .style("white-space","pre")
    .style("font-size","18px")
    .style("font-weight","bold")
    .style("fill","#4f46e5");

  arcs.append("path")
    .attr("d", arc)
    .attr("fill", (d,i)=>color(i))
    .style("transition","all 0.3s")
    .on("mouseover", function(event, d) {
      centerText.text(`${d.data.name}\n${d.data.value}é—¨`).style("opacity",1);
      d3.select(this).style("transform","scale(1.05)").style("filter","brightness(1.1)");
    })
    .on("mouseout", function() {
      centerText.style("opacity",0);
      d3.select(this).style("transform","scale(1)").style("filter","none");
    });

  arcs.append("text")
    .attr("transform", d=>`translate(${arc.centroid(d)})`)
    .attr("class","label")
    .text(d=>d.data.value>0?d.data.name:"")
    .style("fill","white")
    .style("font-size","16px")
    .style("text-anchor","middle");
}

// è¯¾ç¨‹æˆç»©é¥¼å›¾
function initCoursesChart() {
  const svg = d3.select("#courses-chart");
  svg.selectAll("*").remove();
  const width = 400, height = 400, radius = 180; 
  const g = svg.append("g").attr("transform", `translate(${width/2},${height/2})`);
  const color = d3.scaleOrdinal().range([
    '#4f46e5', // é«˜ç­‰æ•°å­¦
    '#6366f1', // çº¿æ€§ä»£æ•°
    '#f59e42', // æ¦‚ç‡è®º
    '#a5b4fc', // ä¿¡å·ä¸ç³»ç»Ÿ
    '#c7d2fe', // å·¥ç¨‹ç”µç£åœº
    '#f472b6', // ç°ä»£ç¼–ç æŠ€æœ¯
    '#34d399', // æ¨¡æ‹Ÿç”µå­æŠ€æœ¯
    '#fbbf24', // æ•°å­—ç”µå­æŠ€æœ¯
    '#10b981', // é«˜é¢‘ç”µå­çº¿è·¯
    '#f87171', // å¾®æœºåŸç†
    '#60a5fa', // å¯ç¼–ç¨‹å™¨ä»¶åŸç†
    '#a3e635', // è™šæ‹Ÿæ˜¾ç¤ºæŠ€æœ¯
    '#8b5cf6'  // æ™ºèƒ½æ•°æ®åˆ†æç¨‹åºè®¾è®¡
  ]);
  const data = courseData.sort((a, b) => b.value - a.value); 
  const pie = d3.pie().value(d=>d.value).sort(null);
  // åŠ åšç¯å½¢å›¾
  const arc = d3.arc().innerRadius(radius * 0.35).outerRadius(radius);
  const arcs = g.selectAll("arc").data(pie(data)).enter().append("g");

  arcs.append("path")
    .attr("d", arc)
    .attr("fill", (d,i)=>color(i))
    .style("transition","all 0.3s")
    .on("mouseover", function(event, d) {
      centerText.text(`${d.data.name}\n${d.data.value}åˆ†`).style("opacity",1);
      d3.select(this).style("transform","scale(1.05)").style("filter","brightness(1.1)");
    })
    .on("mouseout", function() {
      centerText.style("opacity",0);
      d3.select(this).style("transform","scale(1)").style("filter","none");
    });

  const centerText = g.append("text")
    .attr("class","tooltip")
    .style("opacity",0)
    .attr("text-anchor","middle")
    .attr("alignment-baseline","middle")
    .style("white-space","pre")
    .style("font-size","16px")
    .style("font-weight","bold")
    .style("fill","#4f46e5");

  // ä¼˜åŒ–æ ‡ç­¾æ¢è¡Œå’Œå­—ä½“
  arcs.append("text")
    .attr("transform", d => {
      const pos = arc.centroid(d);
      return `translate(${pos})`;
    })
    .attr("class","label")
    .selectAll("tspan")
    .data(d => {
      const name = d.data.name;
      // æŠ€æœ¯ç±»ä¼˜å…ˆåœ¨"æŠ€æœ¯"å‰æ¢è¡Œ
      if (name.length > 6 && name.includes('æŠ€æœ¯')) {
        const arr = name.split('æŠ€æœ¯');
        return arr.length === 2 ? [arr[0], 'æŠ€æœ¯'] : [name];
      } else if (name.length > 8) {
        let breakPoint = Math.floor(name.length / 2);
        if (name.length > 10) breakPoint = 5;
        if (breakPoint > 0 && breakPoint < name.length -1 && /[\u4e00-\u9fa5]/.test(name[breakPoint-1]) && /[\u4e00-\u9fa5]/.test(name[breakPoint])) {
          return [name.substring(0, breakPoint), name.substring(breakPoint)];
        }
      }
      return [name];
    })
    .enter().append("tspan")
    .attr("x", 0)
    .attr("dy", (d, i) => i === 0 ? 0 : "1.2em")
    .text(d => d)
    .style("fill","white")
    .style("font-size","10px")
    .style("text-anchor","middle")
    .style("pointer-events","none");
}

// åœ¨æˆå°±é¡µé¢æ˜¾ç¤ºæ—¶åˆå§‹åŒ–å›¾è¡¨
document.getElementById('nav-archive').addEventListener('click', function() {
  setTimeout(() => {
    initGradesChart();
    initCoursesChart();
  }, 100);
});

// ç›‘å¬çª—å£å¤§å°å˜åŒ–
window.addEventListener('resize', function() {
  if (document.getElementById('archive-section').style.display === 'block') {
    initGradesChart();
    initCoursesChart();
  }
});

// è¯¾ç¨‹æˆç»©æ•°æ®
const courseData = [
  { name: 'é«˜ç­‰æ•°å­¦', value: 83 },
  { name: 'çº¿æ€§ä»£æ•°', value: 96 },
  { name: 'æ¦‚ç‡è®º', value: 83 },
  { name: 'ä¿¡å·ä¸ç³»ç»Ÿ', value: 76 },
  { name: 'å·¥ç¨‹ç”µç£åœº', value: 80 },
  { name: 'ç°ä»£ç¼–ç æŠ€æœ¯', value: 91 },
  { name: 'æ¨¡æ‹Ÿç”µå­æŠ€æœ¯', value: 88 },
  { name: 'æ•°å­—ç”µå­æŠ€æœ¯', value: 87 },
  { name: 'é«˜é¢‘ç”µå­çº¿è·¯', value: 87 },
  { name: 'å¾®æœºåŸç†', value: 83 },
  { name: 'å¯ç¼–ç¨‹å™¨ä»¶åŸç†', value: 90 },
  { name: 'è™šæ‹Ÿæ˜¾ç¤ºæŠ€æœ¯', value: 83 },
  { name: 'æ™ºèƒ½æ•°æ®åˆ†æç¨‹åºè®¾è®¡', value: 90 }
];

// ç»Ÿè®¡æˆç»©ç­‰çº§åˆ†å¸ƒ
function getGradeLevelData() {
  let excellent = 0, good = 0, medium = 0, pass = 0;
  courseData.forEach(d => {
    if (d.value >= 90) excellent++;
    else if (d.value >= 80) good++;
    else if (d.value >= 70) medium++;
    else if (d.value >= 60) pass++;
  });
  return [
    { name: 'ä¼˜ç§€', value: excellent },
    { name: 'è‰¯å¥½', value: good },
    { name: 'ä¸­ç­‰', value: medium },
    { name: 'åŠæ ¼', value: pass }
  ];
}
</script>

<style>
#profile-section #tree-of-life-embed .container {
  max-width: 100vw;
  padding: 0;
  background: #fff;
}
#profile-section #tree-of-life-embed h1 {
  font-size: 2.2rem;
  color: #4f46e5;
  margin-bottom: 1.2rem;
}
#profile-section #tree-of-life-embed svg {
  background: #f8f4e8 !important;
}
</style>

<!-- å…¨å±æ¯”ç‰¹å¸Kçº¿å¼¹çª— -->
<div id="btc-kline-fullscreen" style="display:none;position:fixed;z-index:9999;top:0;left:0;width:100vw;height:100vh;background:#18181a;align-items:center;justify-content:center;flex-direction:column;">
  <button id="close-btc-kline" style="position:absolute;top:32px;right:48px;z-index:10000;font-size:22px;padding:10px 24px;border-radius:8px;border:none;background:rgba(255,255,255,0.85);color:#222;cursor:pointer;">å…³é—­</button>
  <div id="btc-kline-chart" style="width:90vw;height:80vh;background:#fff;border-radius:12px;"></div>
</div>
